<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.36">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Telling Stories with Data - 9&nbsp; Gather data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./10-hunt.html" rel="next">
<link href="./08-farm.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Gather data</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Telling Stories with Data</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/RohanAlexander/telling_stories/" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00-author.html" class="sidebar-item-text sidebar-link">About the author</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Foundations</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-introduction.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Telling stories with data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-drinking_from_a_fire_hose.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Drinking from a fire hose</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-r_essentials.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R essentials</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-workflow.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Reproducible workflows</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Communication</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-writing_research.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Writing research</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-static_communication.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Static communication</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-interactive_communication.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Interactive communication</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">Acquisition</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-farm.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Farm data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-gather.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Gather data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-hunt.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Hunt data</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">Preparation</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-clean_and_prepare.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Clean and prepare</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-store_and_share.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Store and share</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">Modelling</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-eda.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Exploratory data analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-ijalm.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Linear models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-causality_from_obs.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Causality from observational data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-mrp.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Multilevel regression with post-stratification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-text.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Text as data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18-concluding.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Concluding remarks</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">Appendices</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22-datasets.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23-rmarkdown.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">R Markdown</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24-assessment.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Papers</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25-datasheet.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Datasheet</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./98-cocktails.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Cocktails</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99-references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"> <span class="header-section-number">9.1</span> Introduction</a></li>
  <li><a href="#apis" id="toc-apis" class="nav-link" data-scroll-target="#apis"> <span class="header-section-number">9.2</span> APIs</a>
  <ul class="collapse">
  <li><a href="#gathering-data-from-arxiv-nasa-and-dataverse" id="toc-gathering-data-from-arxiv-nasa-and-dataverse" class="nav-link" data-scroll-target="#gathering-data-from-arxiv-nasa-and-dataverse"> <span class="header-section-number">9.2.1</span> Gathering data from arXiv, NASA, and Dataverse</a></li>
  <li><a href="#gathering-data-from-twitter" id="toc-gathering-data-from-twitter" class="nav-link" data-scroll-target="#gathering-data-from-twitter"> <span class="header-section-number">9.2.2</span> Gathering data from Twitter</a></li>
  <li><a href="#gathering-data-from-spotify" id="toc-gathering-data-from-spotify" class="nav-link" data-scroll-target="#gathering-data-from-spotify"> <span class="header-section-number">9.2.3</span> Gathering data from Spotify</a></li>
  </ul></li>
  <li><a href="#web-scraping" id="toc-web-scraping" class="nav-link" data-scroll-target="#web-scraping"> <span class="header-section-number">9.3</span> Web scraping</a>
  <ul class="collapse">
  <li><a href="#book-information" id="toc-book-information" class="nav-link" data-scroll-target="#book-information"> <span class="header-section-number">9.3.1</span> Book information</a></li>
  <li><a href="#uk-prime-ministers-from-wikipedia" id="toc-uk-prime-ministers-from-wikipedia" class="nav-link" data-scroll-target="#uk-prime-ministers-from-wikipedia"> <span class="header-section-number">9.3.2</span> UK Prime Ministers from Wikipedia</a></li>
  <li><a href="#downloading-multiple-files" id="toc-downloading-multiple-files" class="nav-link" data-scroll-target="#downloading-multiple-files"> <span class="header-section-number">9.3.3</span> Downloading multiple files</a></li>
  </ul></li>
  <li><a href="#pdfs" id="toc-pdfs" class="nav-link" data-scroll-target="#pdfs"> <span class="header-section-number">9.4</span> PDFs</a>
  <ul class="collapse">
  <li><a href="#jane-eyre" id="toc-jane-eyre" class="nav-link" data-scroll-target="#jane-eyre"> <span class="header-section-number">9.4.1</span> Jane Eyre</a></li>
  <li><a href="#us-total-fertility-rate" id="toc-us-total-fertility-rate" class="nav-link" data-scroll-target="#us-total-fertility-rate"> <span class="header-section-number">9.4.2</span> US Total Fertility Rate</a></li>
  <li><a href="#optical-character-recognition" id="toc-optical-character-recognition" class="nav-link" data-scroll-target="#optical-character-recognition"> <span class="header-section-number">9.4.3</span> Optical Character Recognition</a></li>
  </ul></li>
  <li><a href="#exercises-and-tutorial" id="toc-exercises-and-tutorial" class="nav-link" data-scroll-target="#exercises-and-tutorial"> <span class="header-section-number">9.5</span> Exercises and tutorial</a>
  <ul class="collapse">
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  <li><a href="#tutorial" id="toc-tutorial" class="nav-link" data-scroll-target="#tutorial">Tutorial</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/RohanAlexander/telling_stories/edit/main/09-gather.qmd" class="toc-action">Edit this page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-gather-data" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Gather data</span></span></h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p><strong>Required material</strong></p>
<ul>
<li>Read <em>Turning History into Data: Data Collection, Measurement, and Inference in HPE</em>, <span class="citation" data-cites="cirone">(<a href="99-references.html#ref-cirone" role="doc-biblioref">Cirone and Spirling 2021</a>)</span></li>
<li>Read <em>Two Regimes of Prison Data Collection</em>, <span class="citation" data-cites="Johnson2021Two">(<a href="99-references.html#ref-Johnson2021Two" role="doc-biblioref">Johnson 2021</a>)</span></li>
<li>Read <em>Atlas of AI</em>, Chapter 3 “Data”, <span class="citation" data-cites="crawford">(<a href="99-references.html#ref-crawford" role="doc-biblioref">Crawford 2021</a>)</span></li>
</ul>
<p><strong>Key concepts and skills</strong></p>
<ul>
<li>Sometimes data are available, but they are not necessarily put together for the purposes of being a dataset. We have to go and gather such data.</li>
<li>It can be cumbersome and annoying to have to clean and prepare the datasets that come from these unstructured sources, however, the resulting structured, tidy, data are often especially exciting and useful.</li>
<li>We can gather data from a variety of sources, including APIs, both directly, including dealing with semi-structured data, and indirectly through R Packages. We can also gather data through web scraping, although it is important to consider reasonable use and ethical concerns. Finally, we may wish to gather data from PDFs, possibly even needing to OCR them.</li>
</ul>
<p><strong>Key packages and functions</strong></p>
<ul>
<li>Base R
<ul>
<li><code>download.file()</code></li>
<li><code>factor()</code></li>
<li><code>function()</code></li>
<li><code>set.seed()</code></li>
<li><code>sys.sleep()</code></li>
</ul></li>
<li><code>httr</code> <span class="citation" data-cites="citehttr">(<a href="99-references.html#ref-citehttr" role="doc-biblioref">Wickham 2019a</a>)</span>
<ul>
<li><code>GET()</code></li>
<li><code>content()</code></li>
</ul></li>
<li><code>jsonlite</code> <span class="citation" data-cites="jsonlite">(<a href="99-references.html#ref-jsonlite" role="doc-biblioref">Ooms 2014</a>)</span>
<ul>
<li><code>fromJSON()</code></li>
</ul></li>
<li><code>pdftools</code> <span class="citation" data-cites="pdftools">(<a href="99-references.html#ref-pdftools" role="doc-biblioref">Ooms 2019a</a>)</span>
<ul>
<li><code>pdf_text()</code></li>
</ul></li>
<li><code>purrr</code> <span class="citation" data-cites="citepurrr">(<a href="99-references.html#ref-citepurrr" role="doc-biblioref">Henry and Wickham 2020</a>)</span>
<ul>
<li><code>walk2()</code></li>
</ul></li>
<li><code>rtweet</code> <span class="citation" data-cites="rtweet">(<a href="99-references.html#ref-rtweet" role="doc-biblioref">Kearney 2019</a>)</span>
<ul>
<li><code>get_favorites()</code></li>
<li><code>get_friends()</code></li>
<li><code>get_timelines()</code></li>
<li><code>search_tweets()</code></li>
</ul></li>
<li><code>rvest</code> <span class="citation" data-cites="citervest">(<a href="99-references.html#ref-citervest" role="doc-biblioref">Wickham 2019b</a>)</span>
<ul>
<li><code>html_nodes()</code></li>
<li><code>html_text()</code></li>
</ul></li>
<li><code>spotifyr</code> <span class="citation" data-cites="spotifyr">(<a href="99-references.html#ref-spotifyr" role="doc-biblioref">Thompson et al. 2020</a>)</span>
<ul>
<li><code>get_artist_audio_features()</code></li>
</ul></li>
<li><code>tesseract</code> <span class="citation" data-cites="citetesseract">(<a href="99-references.html#ref-citetesseract" role="doc-biblioref">Ooms 2019b</a>)</span>
<ul>
<li><code>ocr()</code></li>
</ul></li>
<li>Outer <code>tidyverse</code> <span class="citation" data-cites="tidyverse">(<a href="99-references.html#ref-tidyverse" role="doc-biblioref">Wickham et al. 2019</a>)</span> (need to be loaded separately e.g.&nbsp;<code>library("haven")</code>)
<ul>
<li><code>lubridate</code> <span class="citation" data-cites="GrolemundWickham2011">(<a href="99-references.html#ref-GrolemundWickham2011" role="doc-biblioref">Grolemund and Wickham 2011</a>)</span>
<ul>
<li><code>ymd()</code></li>
</ul></li>
</ul></li>
<li><code>usethis</code> <span class="citation" data-cites="citeusethis">(<a href="99-references.html#ref-citeusethis" role="doc-biblioref">Wickham and Bryan 2020</a>)</span>
<ul>
<li><code>edit_r_environ()</code></li>
</ul></li>
<li><code>xml2</code> <span class="citation" data-cites="xml2">(<a href="99-references.html#ref-xml2" role="doc-biblioref">Wickham, Hester, and Ooms 2021</a>)</span>
<ul>
<li><code>read_xml()</code></li>
<li><code>html_structure()</code></li>
<li><code>xml_child()</code></li>
<li><code>xml_attr()</code></li>
<li><code>xml_text()</code></li>
</ul></li>
</ul>
<section id="introduction" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">9.1</span> Introduction</h2>
<p>In this chapter we consider data that we must gather ourselves. This means that although the observations exist, we have to parse, pull, clean, and prepare them into the dataset that we will consider. In contrast to farmed data, discussed in <a href="08-farm.html"><span>Chapter&nbsp;8</span></a>, typically, these felicitous observations are not being made available for us for the purpose of analysis. This means we need to be especially concerned with documentation, inclusion and exclusion decisions, missing data, and ethical behavior.</p>
<p>As a preeminent example of such a gathered dataset, consider <span class="citation" data-cites="Cummins2022">Cummins (<a href="99-references.html#ref-Cummins2022" role="doc-biblioref">2022</a>)</span> who use individual-level probate records from England between 1892 and 1992 to create a dataset that they then use to estimate how much wealth was being hidden. They find that about a third of the inheritance of “elites” is concealed. Wills are clearly not created for the purpose of being included in a dataset, but with a respectful approach they enable insights that we could not get by other means.</p>
<p>Decisions need to be made at the start of a project about the values we want the project to have. For instance, <span class="citation" data-cites="huggingfaceethics">Saulnier et al. (<a href="99-references.html#ref-huggingfaceethics" role="doc-biblioref">2022</a>)</span> value transparency, reproducibility, fairness, being self-critical, and giving credit. How might that affect the project? Valuing “giving credit” might mean being especially zealous about considering attribution and licensing. And being “self-critical” might mean going out of one’s way to not make more of results than is appropriate.</p>
<p>The results of a data science workflow will never be better than their data <span class="citation" data-cites="bailey2008design">(<a href="99-references.html#ref-bailey2008design" role="doc-biblioref">Bailey 2008</a>)</span>. And even the best statistical analysis will struggle to adjust for poorly gathered data. This means when working in a team, it is important that data gathering is conducted and overseen by the senior members of the team. And when working by oneself, it is important to give special consideration and care to this stage.</p>
<p>In this chapter we go through a variety of approaches for gathering data. We begin with the use of APIs and semi-structured data, such as JSON and XML. These are situations in which data providers typically specify the conditions under they are comfortable providing access. An API allows us to write code to gather data. Making data available in this way is a critical aspect of technology firms. It is especially valuable because it can be efficient and scales well.</p>
<p>We then turn to web scraping, which we may want to use when there are data available on a website. As these data have typically not been put together for the purposes of being a dataset, it is especially important to have deliberate and definite values for the project. Scraping is a critical part of data gathering because there are many data sources where the priorities of the data provider mean they have not implemented an API. For instance, considerable use of web scraping was critical for creating COVID-19 dashboards in the early days of the pandemic <span class="citation" data-cites="scrapecoviddata">(<a href="99-references.html#ref-scrapecoviddata" role="doc-biblioref">Eisenstein 2022</a>)</span>.</p>
<p>Finally, we consider gathering data from PDFs. While less common than needing to gather data from APIs or scraping, gathering data from PDFs opens up critical datasets, especially those contained in government reports and old books.</p>
<p>Gathering data requires more of us than using farmed data, but it allows us to explore especially exciting datasets and answer questions that we could not otherwise. Some of the most exciting work in the world uses gathered data, but it is especially important that we approach it with respect.</p>
</section>
<section id="apis" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="apis"><span class="header-section-number">9.2</span> APIs</h2>
<p>In everyday language, and for our purposes, an Application Programming Interface (API) is a situation in which someone has set up specific files on their computer such that we can follow their instructions to get them. For instance, when we use a gif on Slack, Slack asks Giphy’s server for the appropriate gif, Giphy’s server gives that gif to Slack and then Slack inserts it into chat. The way in which Slack and Giphy interact is determined by Giphy’s API. More strictly, an API is just an application that runs on a server that we access using the HTTP protocol.</p>
<p>Here we focus on using APIs for gathering data. And so, with that focus, an API is a website that is set-up for another computer to be able to access, rather than a person. For instance, we could go to <a href="https://www.google.com/maps">Google Maps</a>. And we could then scroll and click and drag to center the map on, say, Canberra, Australia. Or we could paste <a href="https://www.google.com/maps/@-35.2812958,149.1248113,16z">this link</a> into the browser. By pasting that link, rather than navigating, we have mimicked how we will use an API: provide it with a URL and be given something back. In this case the result should be a map similar to <a href="#fig-focuson2020">Figure&nbsp;<span>9.1</span></a>.</p>
<div id="fig-focuson2020" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/googlemaps.png" class="img-fluid figure-img" style="width:90.0%"></p>
<p></p><figcaption class="figure-caption">Figure 9.1: Example of Google Maps, as at 29 January 2022</figcaption><p></p>
</figure>
</div>
<p>The advantage of using an API is that the data provider specifies exactly the data that they are willing to provide, and the terms under which they will provide it. These terms may include aspects such as rate limits (i.e.&nbsp;how often we can ask for data), and what we can do with the data, for instance, we might not be allowed to use it for commercial purposes, or to republish it. Additionally, because the API is being provided specifically for us to use it, it is less likely to be subject to unexpected changes or legal issues. Because of this it is clear that when an API is available, we should try to use it rather than web scraping.</p>
<p>We will now go through a few case studies of using APIs. In the first we deal directly with an API using <code>httr</code> <span class="citation" data-cites="citehttr">(<a href="99-references.html#ref-citehttr" role="doc-biblioref">Wickham 2019a</a>)</span>. In the second we access data from Twitter using <code>rtweet</code> <span class="citation" data-cites="rtweet">(<a href="99-references.html#ref-rtweet" role="doc-biblioref">Kearney 2019</a>)</span>. And in the third we access data from Spotify using <code>spotifyr</code> <span class="citation" data-cites="spotifyr">(<a href="99-references.html#ref-spotifyr" role="doc-biblioref">Thompson et al. 2020</a>)</span>. Developing comfort with gathering data through APIs enables access to exciting datasets. For instance, <span class="citation" data-cites="facebookapitrump">Wong (<a href="99-references.html#ref-facebookapitrump" role="doc-biblioref">2020</a>)</span> use the Facebook Political Ad API to gather all 218,100 of the Trump 2020 campaign ads to better understand the campaign.</p>
<section id="gathering-data-from-arxiv-nasa-and-dataverse" class="level3" data-number="9.2.1">
<h3 data-number="9.2.1" class="anchored" data-anchor-id="gathering-data-from-arxiv-nasa-and-dataverse"><span class="header-section-number">9.2.1</span> Gathering data from arXiv, NASA, and Dataverse</h3>
<p>We use <code>GET()</code> from <code>httr</code> <span class="citation" data-cites="citehttr">(<a href="99-references.html#ref-citehttr" role="doc-biblioref">Wickham 2019a</a>)</span> to obtain data from an API directly. This will try to get some specific data and the main argument is “url”. In a way, this is similar to the earlier Google Maps example. In that example, the specific information that we were interested in was a map.</p>
<p>In this case study we will use an <a href="https://arxiv.org/help/api/">API provided by arXiv</a>. arXiv is an online repository for academic papers before they go through peer-review, and these are typically referred to as “pre-prints”. After installing and loading <code>httr</code>, we use <code>GET()</code> to ask arXiv to obtain some information about the pre-print of <span class="citation" data-cites="Alexander2020">Alexander and Alexander (<a href="99-references.html#ref-Alexander2020" role="doc-biblioref">2021</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xml2)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>arxiv <span class="ot">&lt;-</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">GET</span>(<span class="st">"http://export.arxiv.org/api/query?id_list=2111.09299"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">status_code</span>(arxiv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 200</code></pre>
</div>
</div>
<p>We can use <code>status_code()</code> to check whether we received an error from the server. And assuming we received something back from the server, we can use <code>content()</code> to display the information. In this case we have received XML formatted data. XML is a markup language where entries are identified by tags, which can be nested within other tags. We can read XML using <code>read_xml()</code> from <code>xml2</code> <span class="citation" data-cites="xml2">(<a href="99-references.html#ref-xml2" role="doc-biblioref">Wickham, Hester, and Ooms 2021</a>)</span>. XML is a semi-formatted structure, and it can be useful to start by having a look at it using <code>html_structure()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">content</span>(arxiv) <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_xml</span>() <span class="sc">|&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_structure</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;feed [xmlns]&gt;
  &lt;link [href, rel, type]&gt;
  &lt;title [type]&gt;
    {text}
  &lt;id&gt;
    {text}
  &lt;updated&gt;
    {text}
  &lt;totalResults [xmlns:opensearch]&gt;
    {text}
  &lt;startIndex [xmlns:opensearch]&gt;
    {text}
  &lt;itemsPerPage [xmlns:opensearch]&gt;
    {text}
  &lt;entry&gt;
    &lt;id&gt;
      {text}
    &lt;updated&gt;
      {text}
    &lt;published&gt;
      {text}
    &lt;title&gt;
      {text}
    &lt;summary&gt;
      {text}
    &lt;author&gt;
      &lt;name&gt;
        {text}
    &lt;author&gt;
      &lt;name&gt;
        {text}
    &lt;comment [xmlns:arxiv]&gt;
      {text}
    &lt;link [href, rel, type]&gt;
    &lt;link [title, href, rel, type]&gt;
    &lt;primary_category [term, scheme, xmlns:arxiv]&gt;
    &lt;category [term, scheme]&gt;</code></pre>
</div>
</div>
<p>We might be interested to create a dataset based on extracting various aspects of this XML tree. For instance, we might look at “entry”, which is the eighth item, and in particular obtain the “title” and the “URL”, which are the fourth and ninth items, respectively, within “entry”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>data_from_arxiv <span class="ot">&lt;-</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">content</span>(arxiv) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">read_xml</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xml_child</span>(<span class="at">search =</span> <span class="dv">8</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xml_child</span>(<span class="at">search =</span> <span class="dv">4</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xml_text</span>(),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">link =</span> <span class="fu">content</span>(arxiv) <span class="sc">|&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">read_xml</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xml_child</span>(<span class="at">search =</span> <span class="dv">8</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xml_child</span>(<span class="at">search =</span> <span class="dv">9</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xml_attr</span>(<span class="st">"href"</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>data_from_arxiv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  title                                                                    link 
  &lt;chr&gt;                                                                    &lt;chr&gt;
1 "The Increased Effect of Elections and Changing Prime Ministers on Topi… http…</code></pre>
</div>
</div>
<p>To consider another example, each day NASA provides the Astronomy Picture of the Day (APOD) through its <a href="https://api.nasa.gov">APOD API</a>. We can again use <code>GET()</code> to obtain the URL for the photo on particular dates and then display it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>NASA_APOD_20211226 <span class="ot">&lt;-</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">GET</span>(<span class="st">"https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY&amp;date=2021-12-26"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>NASA_APOD_20190719 <span class="ot">&lt;-</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">GET</span>(<span class="st">"https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY&amp;date=2019-07-19"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Examining the returned data using <code>content()</code>, we can see that we are provided with various fields, such as date, title, explanation, and a URL. And we can provide that URL to <code>include_graphics()</code> from <code>knitr</code> to display it (<a href="#fig-nasaone">Figure&nbsp;<span>9.2</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># APOD December 26, 2021</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">content</span>(NASA_APOD_20211226)<span class="sc">$</span>date</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2021-12-26"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">content</span>(NASA_APOD_20211226)<span class="sc">$</span>title</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "James Webb Space Telescope over Earth"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">content</span>(NASA_APOD_20211226)<span class="sc">$</span>explanation</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "There's a big new telescope in space. This one, the James Webb Space Telescope (JWST), not only has a mirror over five times larger than Hubble's in area, but can see better in infrared light. The featured picture shows JWST high above the Earth just after being released by the upper stage of an Ariane V rocket, launched yesterday from French Guiana. Over the next month, JWST will move out near the Sun-Earth L2 point where it will co-orbit the Sun with the Earth. During this time and for the next five months, JWST will unravel its segmented mirror and an array of sophisticated scientific instruments -- and test them. If all goes well, JWST will start examining galaxies across the universe and planets orbiting stars across our Milky Way Galaxy in the summer of 2022.   APOD Gallery: Webb Space Telescope Launch"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">content</span>(NASA_APOD_20211226)<span class="sc">$</span>url</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "https://apod.nasa.gov/apod/image/2112/JwstLaunch_Arianespace_1080.jpg"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># APOD July 19, 2019</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">content</span>(NASA_APOD_20190719)<span class="sc">$</span>date</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2019-07-19"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">content</span>(NASA_APOD_20190719)<span class="sc">$</span>title</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Tranquility Base Panorama"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">content</span>(NASA_APOD_20190719)<span class="sc">$</span>explanation</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "On July 20, 1969 the Apollo 11 lunar module Eagle safely touched down on the Moon. It landed near the southwestern corner of the Moon's Mare Tranquillitatis at a landing site dubbed Tranquility Base. This panoramic view of Tranquility Base was constructed from the historic photos taken from the lunar surface. On the far left astronaut Neil Armstrong casts a long shadow with Sun is at his back and the Eagle resting about 60 meters away ( AS11-40-5961). He stands near the rim of 30 meter-diameter Little West crater seen here to the right ( AS11-40-5954). Also visible in the foreground is the top of the camera intended for taking stereo close-ups of the lunar surface."</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">content</span>(NASA_APOD_20190719)<span class="sc">$</span>url</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "https://apod.nasa.gov/apod/image/1907/apollo11TranquilitybasePan600h.jpg"</code></pre>
</div>
</div>
<div id="fig-nasaone" class="quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-jameswebb" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/JwstLaunch_Arianespace_1080.jpg" class="img-fluid figure-img" data-ref-parent="fig-nasaone"></p>
<p></p><figcaption class="figure-caption">(a) Photo of the James Webb Space Telescope over Earth</figcaption><p></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-nasamoon" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/apollo11TranquilitybasePan.jpg" class="img-fluid figure-img" data-ref-parent="fig-nasaone"></p>
<p></p><figcaption class="figure-caption">(b) Photo of Tranquility Base</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure 9.2: Images obtained from the NASA APOD API</figcaption><p></p>
</figure>
</div>
<p>Finally, another common API response in semi-structured form is JSON. <a href="https://www.json.org/json-en.html">JSON</a> is a human-readable way to store data that can be parsed by machines. In contrast to, say, a CSV, where we are used to rows and columns, JSON uses key-value pairs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode css code-with-copy"><code class="sourceCode css"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  "firstName"<span class="in">: "Rohan</span>"<span class="op">,</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  "lastName"<span class="in">: "Alexander</span>"<span class="op">,</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  "age"<span class="in">: 36,</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  "favFoods"<span class="in">: {</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    "first"<span class="in">: "Pizza</span>"<span class="op">,</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    "second"<span class="in">: "Bagels</span>"<span class="op">,</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    "third"<span class="in">: null</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<style type="text/css">
{
  "firstName": "Rohan",
  "lastName": "Alexander",
  "age": 36,
  "favFoods": {
    "first": "Pizza",
    "second": "Bagels",
    "third": null
  }
}
</style>
</div>
<p>We can parse JSON with <code>jsonlite</code> <span class="citation" data-cites="jsonlite">(<a href="99-references.html#ref-jsonlite" role="doc-biblioref">Ooms 2014</a>)</span>. To consider a specific example, a “Dataverse” is a web application that makes it easier to share dataset. We can use an API to query a demonstration dataverse. For instance, we might be interested in datasets related to politics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>politics_datasets <span class="ot">&lt;-</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fromJSON</span>(<span class="st">"https://demo.dataverse.org/api/search?q=politics"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also look at the dataset using <code>View(politics_datasets)</code>, which allows us to expand the tree based on what we are interested in. We can even get the code that we need to focus on different aspects by hovering on the item and then clicking the icon with the green arrow (<a href="#fig-jsonfirst">Figure&nbsp;<span>9.3</span></a>).</p>
<div id="fig-jsonfirst" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/jsonlite.png" class="img-fluid figure-img" style="width:90.0%"></p>
<p></p><figcaption class="figure-caption">Figure 9.3: Example of hovering over an JSON element, “items”, where the icon with a green arrow can be clicked on to get the code that would focus on that element</figcaption><p></p>
</figure>
</div>
<p>This tells us how to obtain the dataset of interest.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>(politics_datasets[[<span class="st">"data"</span>]][[<span class="st">"items"</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 23
  name       type  url   ident…¹ descr…² publi…³ globa…⁴ publi…⁵ citat…⁶ ident…⁷
  &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  
1 China Arc… data… http… china-… Introd… 2016-1… &lt;NA&gt;    &lt;NA&gt;     &lt;NA&gt;   &lt;NA&gt;   
2 Multiscop… data… http… &lt;NA&gt;    The su… 2022-0… doi:10… UniDat… "Istat… dassi  
3 Aspetti d… data… http… &lt;NA&gt;    The su… 2022-0… doi:10… UniDat… "Istat… dassi  
# … with 13 more variables: name_of_dataverse &lt;chr&gt;, citation &lt;chr&gt;,
#   storageIdentifier &lt;chr&gt;, subjects &lt;list&gt;, fileCount &lt;int&gt;, versionId &lt;int&gt;,
#   versionState &lt;chr&gt;, majorVersion &lt;int&gt;, minorVersion &lt;int&gt;,
#   createdAt &lt;chr&gt;, updatedAt &lt;chr&gt;, contacts &lt;list&gt;, authors &lt;list&gt;, and
#   abbreviated variable names ¹​identifier, ²​description, ³​published_at,
#   ⁴​global_id, ⁵​publisher, ⁶​citationHtml, ⁷​identifier_of_dataverse
# ℹ Use `colnames()` to see all variable names</code></pre>
</div>
</div>
</section>
<section id="gathering-data-from-twitter" class="level3" data-number="9.2.2">
<h3 data-number="9.2.2" class="anchored" data-anchor-id="gathering-data-from-twitter"><span class="header-section-number">9.2.2</span> Gathering data from Twitter</h3>
<p>Twitter is a rich source of text and other data and an extraordinary amount of academic research uses it <span class="citation" data-cites="twitterseemsokay">(<a href="99-references.html#ref-twitterseemsokay" role="doc-biblioref">Pfeffer et al. 2022</a>)</span> The Twitter API is the way in which Twitter asks that we gather these data. <code>rtweet</code> <span class="citation" data-cites="rtweet">(<a href="99-references.html#ref-rtweet" role="doc-biblioref">Kearney 2019</a>)</span> is built around this API and allows us to interact with it in ways that are similar to using any other R package. Initially, we can use the Twitter API with just a regular Twitter account.</p>
<p>Begin by installing and loading <code>rtweet</code> and <code>tidyverse</code>. We then need to authorize <code>rtweet</code> and we start that process by calling any function from the package, for instance <code>get_favorites()</code> which would normally return a tibble of a user’s favorites. When it is executed before authorization, this will open a browser, and we then log into a regular Twitter account (<a href="#fig-rtweetlogin">Figure&nbsp;<span>9.4</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rtweet)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_favorites</span>(<span class="at">user =</span> <span class="st">"RohanAlexander"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fig-rtweetlogin" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/rtweet.png" class="img-fluid figure-img" style="width:90.0%"></p>
<p></p><figcaption class="figure-caption">Figure 9.4: rtweet authorisation page</figcaption><p></p>
</figure>
</div>
<p>Once the application is authorized, we can use <code>get_favorites()</code> to actually get the favorites of a user and save them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>rohans_favorites <span class="ot">&lt;-</span> <span class="fu">get_favorites</span>(<span class="st">"RohanAlexander"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(rohans_favorites, <span class="st">"rohans_favorites.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could then look at some recent favorites, keeping in mind that they may be different depending on when they are being accessed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>rohans_favorites <span class="sc">|&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(created_at)) <span class="sc">|&gt;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(screen_name, text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   screen_name    text                                                          
   &lt;chr&gt;          &lt;chr&gt;                                                         
 1 flynnpolsci    "I put together some quick thoughts after year 1 as a program…
 2 michaelhoffman "What's it called when you subtweet someone, and then they re…
 3 mitani_aa      "Congratulations @xinyangfeng2333 for a superb MSc defense!!!…
 4 apreshill      "@dgkeyes What an esteemed lineup 🤩"                         
 5 nedasoc        "during the hours the mini is in school this week, i need to …
 6 ryancbriggs    "@Geo_Gingerbeard it gets worse"                              
 7 lisalendway    "I modified it to add, “or they’ll make it themselves.” https…
 8 dgkeyes        "Been doing a lot of interviews for my book. Will also be rel…
 9 evanrobertsnz  "Signed, someone hailing from a country that has many things …
10 max_d_rohde    "Logistic regression is a great starting point for understand…</code></pre>
</div>
</div>
<p>We can use <code>search_tweets()</code> to search for tweets about a particular topic. For instance, we could look at tweets using a hashtag commonly associated with R: “#rstats”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>rstats_tweets <span class="ot">&lt;-</span> <span class="fu">search_tweets</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="st">"#rstats"</span>,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_rts =</span> <span class="cn">FALSE</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(rstats_tweets, <span class="st">"rstats_tweets.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>rstats_tweets <span class="sc">|&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(screen_name, text) <span class="sc">|&gt;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  screen_name     text                                                          
  &lt;chr&gt;           &lt;chr&gt;                                                         
1 SuccessAnalytiX "The Science of Success \n\nhttps://t.co/xLM2OrqHBd\n\n#BigDa…
2 babycoin_dev    "BabyCoin (BABY)\n\nGUI wallet v2.05 =&amp;gt; https://t.co/CFNtp…
3 rstatsdata      "#rdata #rstats: Yield of 6 barley varieties at 18 locations …
4 PDH_SciTechNews "#Coding Arm Puts Security Architecture to the Test With New …
5 PDH_SciTechNews "#Coding Network Engineer: Skills, Roles &amp;amp; Responsibiliti…
6 PDH_SciTechNews "#Coding CockroachDB Strengthens Change Data Capture - iProgr…</code></pre>
</div>
</div>
<p>Other useful functions that can be used include <code>get_friends()</code> to get all the accounts that a user follows, and <code>get_timelines()</code> to get a user’s recent tweets. Registering as a developer enables access to more Twitter API functionality.</p>
<p>When using APIs, even when they are wrapped in an R package, in this case <code>rtweet</code>, it is important to read the terms under which access is provided. The Twitter API docs are surprisingly readable, and the <a href="https://developer.twitter.com/en/developer-terms/policy">developer policy</a> is especially clear. To see how easy it is to violate the terms under which an API provider makes data available, consider that we saved the tweets that we downloaded. If we were to push these to GitHub, then it is possible that we may have accidentally stored sensitive information if there happened to be some in the tweets. Twitter is also explicit about asking those that use their API to be especially careful about sensitive information and not matching Twitter users with their off-Twitter identity. Again, the <a href="https://developer.twitter.com/en/developer-terms/more-on-restricted-use-cases">documentation around these restricted uses</a> is clear and readable.</p>
</section>
<section id="gathering-data-from-spotify" class="level3" data-number="9.2.3">
<h3 data-number="9.2.3" class="anchored" data-anchor-id="gathering-data-from-spotify"><span class="header-section-number">9.2.3</span> Gathering data from Spotify</h3>
<p>We use <code>spotifyr</code> <span class="citation" data-cites="spotifyr">(<a href="99-references.html#ref-spotifyr" role="doc-biblioref">Thompson et al. 2020</a>)</span>, which is a wrapper around the Spotify API. Install and load the package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"spotifyr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spotifyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To access the Spotify API, we need a <a href="https://developer.spotify.com/dashboard/">Spotify Developer Account</a>. This will require logging in with a Spotify account and then accepting the Developer Terms (<a href="#fig-spotifyaccept">Figure&nbsp;<span>9.5</span></a>).</p>
<div id="fig-spotifyaccept" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/spotify.png" class="img-fluid figure-img" style="width:90.0%"></p>
<p></p><figcaption class="figure-caption">Figure 9.5: Spotify Developer Account Terms agreement page</figcaption><p></p>
</figure>
</div>
<p>Continuing with the registration process; in our case, we “do not know” what we are building and so Spotify requires us to use a non-commercial agreement. To use the Spotify API we need a “Client ID” and a “Client Secret”. These are things that we want to keep to ourselves because anyone with the details could use our developer account as though they were us. One way to keep these details secret with a minimum of hassle is to keep them in our “System Environment”. In this way, when we push to GitHub they should not be included. (We followed this process without explanation in <a href="07-interactive_communication.html"><span>Chapter&nbsp;7</span></a> when we used <code>mapdeck</code>.) To do this we will use <code>usethis</code> <span class="citation" data-cites="citeusethis">(<a href="99-references.html#ref-citeusethis" role="doc-biblioref">Wickham and Bryan 2020</a>)</span> to modify our System Environment. In particular, there is a file called “.Renviron” which we will open and then add our “Client ID” and “Client Secret”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(usethis)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">edit_r_environ</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we run <code>edit_r_environ()</code>, our “.Renviron” file will open and we can add our “Spotify Client ID” and “Client Secret”. It is important to use the same names, because <code>spotifyr</code> will look in our environment for keys with those specific names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>SPOTIFY_CLIENT_ID <span class="ot">&lt;-</span> <span class="st">"PUT_YOUR_CLIENT_ID_HERE"</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>SPOTIFY_CLIENT_SECRET <span class="ot">&lt;-</span> <span class="st">"PUT_YOUR_SECRET_HERE"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Save the “.Renviron” file, and then restart R (“Session” -&gt; “Restart R”). We can now use our “Spotify Client ID” and “Client Secret” as needed. And functions that require those details as arguments will work without them being explicitly specified again.</p>
<p>To try this out we will get and save some information about Radiohead, the English rock band, using <code>get_artist_audio_features()</code>. One of the required arguments is <code>authorization</code>, but as that is set, by default, to look at the “.Renviron” file, we do not need to specify it here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>radiohead <span class="ot">&lt;-</span> <span class="fu">get_artist_audio_features</span>(<span class="st">"radiohead"</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(radiohead, <span class="st">"radiohead.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>radiohead <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"radiohead.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There is a variety of information available based on songs. We might be interested to see whether their songs are getting longer over time (<a href="#fig-readioovertime">Figure&nbsp;<span>9.6</span></a>). And following the guidance in <a href="06-static_communication.html"><span>Chapter&nbsp;6</span></a> this might be a nice opportunity to additionally use a boxplot to communicate summary statistics, by album at the same time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>radiohead <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(radiohead)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>radiohead <span class="sc">|&gt;</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(artist_name, track_name, album_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 193 × 3
   artist_name track_name                    album_name  
   &lt;chr&gt;       &lt;chr&gt;                         &lt;chr&gt;       
 1 Radiohead   Everything In Its Right Place KID A MNESIA
 2 Radiohead   Kid A                         KID A MNESIA
 3 Radiohead   The National Anthem           KID A MNESIA
 4 Radiohead   How to Disappear Completely   KID A MNESIA
 5 Radiohead   Treefingers                   KID A MNESIA
 6 Radiohead   Optimistic                    KID A MNESIA
 7 Radiohead   In Limbo                      KID A MNESIA
 8 Radiohead   Idioteque                     KID A MNESIA
 9 Radiohead   Morning Bell                  KID A MNESIA
10 Radiohead   Motion Picture Soundtrack     KID A MNESIA
# … with 183 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>radiohead <span class="sc">|&gt;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">album_release_date =</span> <span class="fu">ymd</span>(album_release_date)) <span class="sc">|&gt;</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> album_release_date,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> duration_ms,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> album_release_date</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">width =</span> <span class="fl">0.3</span>, <span class="at">height =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Album release date"</span>,</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Duration of song (ms)"</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-readioovertime" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="09-gather_files/figure-html/fig-readioovertime-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 9.6: Length of each Radiohead song, over time, as gathered from Spotify</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>One interesting variable provided by Spotify about each song is “valence”. The Spotify <a href="https://developer.spotify.com/documentation/web-api/reference/#/operations/get-audio-features">documentation</a> describe this as a measure between 0 and 1 that signals the “the musical positiveness” of the track with higher values being more positive. We might be interested to compare valence over time between a few artists, for instance, Radiohead, The National who are an American rock band, and the American singer Taylor Swift.</p>
<p>First, we need to gather the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>taylor_swift <span class="ot">&lt;-</span> <span class="fu">get_artist_audio_features</span>(<span class="st">"taylor swift"</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>the_national <span class="ot">&lt;-</span> <span class="fu">get_artist_audio_features</span>(<span class="st">"the national"</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(taylor_swift, <span class="st">"taylor_swift.rds"</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(the_national, <span class="st">"the_national.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we can bring them together and make the graph (<a href="#fig-swiftyvsnationalvsradiohead">Figure&nbsp;<span>9.7</span></a>). This appears to show that while Taylor Swift and Radiohead have largely maintained their level of valence over time, The National has decreased theirs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>three_artists <span class="ot">&lt;-</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(taylor_swift, the_national, radiohead) <span class="sc">|&gt;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(artist_name, album_release_date, valence) <span class="sc">|&gt;</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">album_release_date =</span> <span class="fu">ymd</span>(album_release_date))</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>three_artists <span class="sc">|&gt;</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> album_release_date,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> valence,</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> artist_name</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vars</span>(artist_name),</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">dir =</span> <span class="st">"v"</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Album release date"</span>,</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Valence"</span>,</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Artist"</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-swiftyvsnationalvsradiohead" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="09-gather_files/figure-html/fig-swiftyvsnationalvsradiohead-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 9.7: Comparing valence, over time, for Radiohead, Taylor Swift, and The National</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>How amazing that we live in a world that all that information is available with very little effort or cost! And having gathered the data, there is a lot that could be done. For instance, <span class="citation" data-cites="kaylinpavlik">Pavlik (<a href="99-references.html#ref-kaylinpavlik" role="doc-biblioref">2019</a>)</span> uses an expanded dataset to classify musical genres and <span class="citation" data-cites="theeconomistonspotify">The Economist (<a href="99-references.html#ref-theeconomistonspotify" role="doc-biblioref">2022</a>)</span> looks at how language is associated with music streaming on Spotify. Our ability to gather such data enables us to answer questions that had to be considered experimentally in the past. For instance <span class="citation" data-cites="salganik2006experimental">Salganik, Dodds, and Watts (<a href="99-references.html#ref-salganik2006experimental" role="doc-biblioref">2006</a>)</span> had to use experimental data to analyse the social aspect of what makes a hit song, rather than the real data we are able to access. But at the same time, it is worth thinking about what valence is purporting to measure. Little information is available in the Spotify documentation about how this is being created. And it is doubtful that one number can completely represent how positive a song is. And what about the songs from these artists that are not on Spotify, or even publicly released? This is a nice example of how measurement and sampling pervade all aspects.</p>
<!-- ## NBA statistics -->
<!-- NBA: https://github.com/toddwschneider/ballr -->
<!-- ## tidyquant -->
<!-- Financial markets data: tidyquant -->
<!-- ## Danish statistics -->
<!-- https://cran.r-project.org/web/packages/danstat/vignettes/Introduction_to_danstat.html -->
</section>
</section>
<section id="web-scraping" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="web-scraping"><span class="header-section-number">9.3</span> Web scraping</h2>
<p>Web scraping is a way to get data from websites. Rather than going to a website using a browser and then saving a copy of it, we write code that does it for us. This opens a lot of data to us, but on the other hand, it is not typically data that are being made available for these purposes. This means that it is especially important to be respectful. While generally not illegal, the specifics about the legality of web scraping depend on jurisdictions and what we are doing, and so it is also important to be mindful. While our use would rarely be commercially competitive, of particular concern is the conflict between the need for our work to be reproducible with the need to respect terms of service that may disallow data republishing <span class="citation" data-cites="luscombe2021algorithmic">(<a href="99-references.html#ref-luscombe2021algorithmic" role="doc-biblioref">Luscombe, Dick, and Walby 2021</a>)</span>.</p>
<p>Privacy trumps reproducibility. There is also a considerable difference between data being publicly available on a website and being scraped, cleaned, and prepared into a dataset which is then publicly released. For instance, <span class="citation" data-cites="kirkegaard2016okcupid">Kirkegaard and Bjerrekær (<a href="99-references.html#ref-kirkegaard2016okcupid" role="doc-biblioref">2016</a>)</span> scraped publicly available OKCupid profiles and then made the resulting dataset easily available <span class="citation" data-cites="hackett2016researchers">(<a href="99-references.html#ref-hackett2016researchers" role="doc-biblioref">Hackett 2016</a>)</span>. <span class="citation" data-cites="zimmer2018addressing">Zimmer (<a href="99-references.html#ref-zimmer2018addressing" role="doc-biblioref">2018</a>)</span> detail some of the important considerations that were overlooked including “minimizing harm”, “informed consent”, and ensuring those in the dataset maintain “privacy and confidentiality”. And more generally, while it is correct to say that OKCupid made data public, they did so in a certain context, and when their data was scraped that context was changed.</p>
<p>That all said, web scraping is an invaluable source of data. But they are typically datasets that can be created as a by-product of someone trying to achieve another aim. And web scraping imposes a cost on the website host, and so it is important to reduce this to the extent possible. For instance, a retailer may have a website with their products and their prices. That has not been created deliberately as a source of data, but we can scrape it to create a dataset. The following principles are useful to guide web scraping.</p>
<ol type="1">
<li>Avoid it. Try to use an API wherever possible.</li>
<li>Abide by their desires. Some websites have a “robots.txt” file that contains information about what they are comfortable with scrapers doing, for instance <a href="https://www.google.com/robots.txt">Google’s</a>.</li>
<li>Reduce the impact.
<ul>
<li>Firstly, slow down the scraper, for instance, rather than having it visit the website every second, slow it down using <code>sys.sleep()</code>. If we only need a few hundred files, then why not just have it visit the website a few times a minute, running in the background overnight?</li>
<li>Secondly, consider the timing of when we run our scraper. For instance, if we are scraping a retailer then maybe we should set our script to run from 10pm through to the morning, when fewer customers are likely using the site. Similarly, if it is a government website and they have a big monthly release, then it might be polite to avoid that day.</li>
</ul></li>
<li>Take only what is needed. For instance, we do not need to scrape the entire of Wikipedia if all we need is the names of the ten largest cities in Croatia. This reduces the impact on the website, and allows us to more easily justify our actions.</li>
<li>Only scrape once. This means we should save everything as we go so that we do not have to re-collect data. Similarly, once we have the data, we should keep that separate and not modify it. If we need data over time then we will need to go back, but this is different to needlessly re-scraping a page.</li>
<li>Do not republish the pages that were scraped (this contrasts with datasets that we create from it).</li>
<li>Take ownership and ask permission if possible. At a minimum level all scripts should have our contact details in them. Depending on the circumstances, it may be worthwhile asking for permission before you scrape.</li>
</ol>
<p>Web scraping is possible by taking advantage of the underlying structure of a webpage. We use patterns in the HTML/CSS to get the data that we want. To look at the underlying HTML/CSS we can either:</p>
<ol type="1">
<li>open a browser, right-click, and choose something like “Inspect”; or</li>
<li>save the website and then open it with a text editor rather than a browser.</li>
</ol>
<p>HTML/CSS is a markup language comprised of matching tags. If we want text to be bold, then we would use something like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode css code-with-copy"><code class="sourceCode css"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>&lt;b<span class="op">&gt;</span>My bold text&lt;/b<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similarly, if we want a list, then we start and end the list as well as indicating each item.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode css code-with-copy"><code class="sourceCode css"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>&lt;ul<span class="op">&gt;</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  &lt;li<span class="op">&gt;</span>Learn webscraping&lt;/li<span class="op">&gt;</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  &lt;li<span class="op">&gt;</span>Do data science&lt;/li<span class="op">&gt;</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  &lt;li<span class="op">&gt;</span>Profit&lt;/li<span class="op">&gt;</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>&lt;/ul<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When scraping we will search for these tags.</p>
<p>To get started, we can pretend that we obtained some HTML from a website, and that we want to get the name from it. We can see that the name is in bold, so we want to focus on that feature and extract it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>website_extract <span class="ot">&lt;-</span> <span class="st">"&lt;p&gt;Hi, I’m &lt;b&gt;Rohan&lt;/b&gt; Alexander.&lt;/p&gt;"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will use <code>read_html()</code> from <code>rvest</code> <span class="citation" data-cites="citervest">(<a href="99-references.html#ref-citervest" role="doc-biblioref">Wickham 2019b</a>)</span> to read in the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>rohans_data <span class="ot">&lt;-</span> <span class="fu">read_html</span>(website_extract)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>rohans_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{html_document}
&lt;html&gt;
[1] &lt;body&gt;&lt;p&gt;Hi, I’m &lt;b&gt;Rohan&lt;/b&gt; Alexander.&lt;/p&gt;&lt;/body&gt;</code></pre>
</div>
</div>
<p>The language used by <code>rvest</code> to look for tags is “node”, so we focus on bold nodes. By default <code>html_nodes()</code> returns the tags as well. We can focus on the text that they contain, with <code>html_text()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>rohans_data <span class="sc">|&gt;</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"b"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{xml_nodeset (1)}
[1] &lt;b&gt;Rohan&lt;/b&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>first_name <span class="ot">&lt;-</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  rohans_data <span class="sc">|&gt;</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"b"</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_text</span>()</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>first_name</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Rohan"</code></pre>
</div>
</div>
<p>If you end up doing a lot of web scraping, then <code>polite</code> <span class="citation" data-cites="polite">(<a href="99-references.html#ref-polite" role="doc-biblioref">Perepolkin 2019</a>)</span> may be helpful to better optimize your workflow.</p>
<section id="book-information" class="level3" data-number="9.3.1">
<h3 data-number="9.3.1" class="anchored" data-anchor-id="book-information"><span class="header-section-number">9.3.1</span> Book information</h3>
<p>In this case study we will scrape a list of books available <a href="https://rohansbooks.com">here</a>. We will then clean the data and look at the distribution of the first letters of author surnames. It is slightly more complicated than the example above, but the underlying approach is the same: download the website, look for the nodes of interest, extract the information, clean it.</p>
<p>We use <code>rvest</code> <span class="citation" data-cites="citervest">(<a href="99-references.html#ref-citervest" role="doc-biblioref">Wickham 2019b</a>)</span> to download a website, and to then navigate the HTML to find the aspects that we are interested in. And we use <code>tidyverse</code> to clean the dataset. We first need to go to the website and then save a local copy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xml2)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>books_data <span class="ot">&lt;-</span> <span class="fu">read_html</span>(<span class="st">"https://rohansbooks.com"</span>)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="fu">write_html</span>(books_data, <span class="st">"raw_data.html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we need to navigate the HTML to get the aspects that we want. And then put them into some sensible structure. We will start with trying to get the data into a tibble as quickly as possible because this will allow us to more easily use <code>dplyr</code> verbs and <code>tidyverse</code> functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>books_data <span class="ot">&lt;-</span> <span class="fu">read_html</span>(<span class="st">"inputs/my_website/raw_data.html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>books_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{html_document}
&lt;html&gt;
[1] &lt;head&gt;\n&lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8 ...
[2] &lt;body&gt;\n    &lt;h1&gt;Books&lt;/h1&gt;\n\n    &lt;p&gt;\n      This is a list of books that ...</code></pre>
</div>
</div>
<p>To get the data into a tibble we first need to use HTML tags to identify the data that we are interested in. If we look at the website then we need to focus on list items (<a href="#fig-rohansbooks-display">Figure&nbsp;<span>9.8 (a)</span></a>). And we can look at the source, focusing particularly on looking for a list (<a href="#fig-rohansbooks-html">Figure&nbsp;<span>9.8 (b)</span></a>).</p>
<div id="fig-rohansbooks" class="quarto-layout-panel">
<figure class="figure">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-rohansbooks-display" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/books_display.png" class="img-fluid figure-img" data-ref-parent="fig-rohansbooks"></p>
<p></p><figcaption class="figure-caption">(a) Books website as displayed</figcaption><p></p>
</figure>
</div>
</div>
<div class="quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-rohansbooks-html" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/books_source.png" class="img-fluid figure-img" data-ref-parent="fig-rohansbooks"></p>
<p></p><figcaption class="figure-caption">(b) HTML for the top of the books website and the list of books</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure 9.8: Screen captures from the books website as at 16 June 2022</figcaption><p></p>
</figure>
</div>
<p>The tag for a list item is “li”, so we can use that to focus on the list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>text_data <span class="ot">&lt;-</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  books_data <span class="sc">|&gt;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"li"</span>) <span class="sc">|&gt;</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_text</span>()</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>all_books <span class="ot">&lt;-</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">books =</span> text_data)</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(all_books)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 1
  books                                                                         
  &lt;chr&gt;                                                                         
1 "\n        Agassi, Andre, 2009, Open\n      "                                 
2 "\n        Cramer, Richard Ben, 1992, What It Takes: The Way to the White Hou…
3 "\n        DeWitt, Helen, 2000, The Last Samurai\n      "                     
4 "\n        Gelman, Andrew and Jennifer Hill, 2007, Data Analysis Using Regres…
5 "\n        Halberstam, David, 1972, The Best and the Brightest\n      "       
6 "\n        Ignatieff, Michael, 2013, Fire and Ashes: Success and Failure in P…</code></pre>
</div>
</div>
<p>We now need to clean the data. First we want to separate the title and the author using <code>separate()</code> and then clean up the author and title columns. We can take advantage of the fact that the year is present and separate based on that.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>all_books <span class="ot">&lt;-</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  all_books <span class="sc">|&gt;</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">books =</span> <span class="fu">str_squish</span>(books)) <span class="sc">|&gt;</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(books, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"author"</span>, <span class="st">"title"</span>), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">, [[:digit:]]{4}</span><span class="sc">\\</span><span class="st">, "</span>)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>all_books</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 19 × 2
   author                                                              title    
   &lt;chr&gt;                                                               &lt;chr&gt;    
 1 Agassi, Andre                                                       Open     
 2 Cramer, Richard Ben                                                 What It …
 3 DeWitt, Helen                                                       The Last…
 4 Gelman, Andrew and Jennifer Hill                                    Data Ana…
 5 Halberstam, David                                                   The Best…
 6 Ignatieff, Michael                                                  Fire and…
 7 Lewis, Michael                                                      Liar's P…
 8 McElreath, Richard                                                  Statisti…
 9 Petzold, Charles                                                    Code: Th…
10 Pitman, Jim                                                         Probabil…
11 Price A, David                                                      The Pixa…
12 Rhodes, Richard                                                     The Maki…
13 Vanhoenacker, Mark                                                  Skyfaring
14 Vaughan, Diane                                                      The Chal…
15 Waldrop, Mitchell M                                                 The Drea…
16 Waugh, Evelyn                                                       Brideshe…
17 Wickham, Hadley, and Grolemund, Garrett                             R for Da…
18 Witten, Daniela, Gareth James, Robert Tibshirani, and Trevor Hastie Introduc…
19 Yanighara, Hanya                                                    A Little…</code></pre>
</div>
</div>
<p>Finally, we could make, say, a table of the distribution of the first letter of the names (<a href="#tbl-lettersofbooks">Table&nbsp;<span>9.1</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>all_books <span class="sc">|&gt;</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">first_letter =</span> <span class="fu">str_sub</span>(author, <span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(first_letter) <span class="sc">|&gt;</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>() <span class="sc">|&gt;</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"First letter"</span>, <span class="st">"Number of times"</span>),</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">booktabs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">linesep =</span> <span class="st">""</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="tbl-lettersofbooks" class="anchored">
<table class="table table-sm table-striped">
<caption>Table 9.1: Distribution of first letter of author names in a collection of books</caption>
<thead>
<tr class="header">
<th style="text-align: left;">First letter</th>
<th style="text-align: right;">Number of times</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">A</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">C</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">D</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">G</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">H</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">I</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">L</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">M</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">P</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">R</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">V</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">W</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Y</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="uk-prime-ministers-from-wikipedia" class="level3" data-number="9.3.2">
<h3 data-number="9.3.2" class="anchored" data-anchor-id="uk-prime-ministers-from-wikipedia"><span class="header-section-number">9.3.2</span> UK Prime Ministers from Wikipedia</h3>
<p>In this case study we are interested in how long UK prime ministers lived, based on the year that they were born. We will scrape data from Wikipedia using <code>rvest</code> <span class="citation" data-cites="citervest">(<a href="99-references.html#ref-citervest" role="doc-biblioref">Wickham 2019b</a>)</span>, clean it, and then make a graph. Every time we scrape a website things will change. Each scrape will largely be bespoke, even if we can borrow some code from earlier projects. It is completely normal to feel frustrated at times. It helps to begin with an end in mind.</p>
<p>To that end, we can start by generating some simulated data. Ideally, we want a table that has a row for each prime minister, a column for their name, and a column each for the birth and death years. If they are still alive, then that death year can be empty. We know that birth and death years should be somewhere between 1700 and 1990, and that death year should be larger than birth year. Finally, we also know that the years should be integers, and the names should be characters. So, we want something that looks roughly like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(babynames)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">853</span>)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>simulated_dataset <span class="ot">&lt;-</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">prime_minister =</span> <span class="fu">sample</span>(</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> babynames <span class="sc">|&gt;</span> <span class="fu">filter</span>(prop <span class="sc">&gt;</span> <span class="fl">0.01</span>) <span class="sc">|&gt;</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(name) <span class="sc">|&gt;</span> <span class="fu">unique</span>() <span class="sc">|&gt;</span> <span class="fu">unlist</span>(),</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">10</span>,</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">replace =</span> <span class="cn">FALSE</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">birth_year =</span> <span class="fu">sample</span>(</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1700</span><span class="sc">:</span><span class="dv">1990</span>),</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">10</span>,</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">replace =</span> <span class="cn">TRUE</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">years_lived =</span> <span class="fu">sample</span>(</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">c</span>(<span class="dv">50</span><span class="sc">:</span><span class="dv">100</span>),</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">10</span>,</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">replace =</span> <span class="cn">TRUE</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">death_year =</span> birth_year <span class="sc">+</span> years_lived</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(prime_minister, birth_year, death_year, years_lived) <span class="sc">|&gt;</span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(birth_year)</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>simulated_dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 4
   prime_minister birth_year death_year years_lived
   &lt;chr&gt;               &lt;int&gt;      &lt;int&gt;       &lt;int&gt;
 1 Kevin                1813       1908          95
 2 Karen                1832       1896          64
 3 Robert               1839       1899          60
 4 Bertha               1846       1915          69
 5 Jennifer             1867       1943          76
 6 Arthur               1892       1984          92
 7 Donna                1907       2006          99
 8 Emma                 1957       2031          74
 9 Ryan                 1959       2053          94
10 Tyler                1990       2062          72</code></pre>
</div>
</div>
<p>One of the advantages of generating a simulated dataset is that if we are working in groups then one person can start making the graph, using the simulated dataset, while the other person gathers the data. In terms of a graph, we are aiming for something like <a href="#fig-pmsgraphexample">Figure&nbsp;<span>9.9</span></a>.</p>
<div id="fig-pmsgraphexample" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/pms_graph_plan.png" class="img-fluid figure-img" style="width:95.0%"></p>
<p></p><figcaption class="figure-caption">Figure 9.9: Sketch of planned graph showing how long UK prime ministers lived</figcaption><p></p>
</figure>
</div>
<p>We are starting with a question that is of interest, which how long each UK prime minister lived. As such, we need to identify a source of data. While there are plenty of data sources that have the births and deaths of each prime minister, we want one that we can trust, and as we are going to be scraping, we want one that has some structure to it. The <a href="https://en.wikipedia.org/wiki/List_of_prime_ministers_of_the_United_Kingdom">Wikipedia page about UK prime ministers</a> fits both these criteria. As it is a popular page the information is likely to be correct, and the data are available in a table.</p>
<p>We load <code>rvest</code> and then download the page using <code>read_html()</code>. Saving it locally provides us with a copy that we need for reproducibility in case the website changes, and means that we do not have to keep visiting the website. But it is not ours, and so this is typically not something that should be necessarily redistributed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rvest)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>raw_data <span class="ot">&lt;-</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_html</span>(</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"https://en.wikipedia.org/wiki/List_of_prime_ministers_of_the_United_Kingdom"</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_html</span>(raw_data, <span class="st">"pms.html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As with the earlier case study, we are looking for patterns in the HTML that we can use to help us get closer to the data that we want. This is an iterative process and requires a lot of trial and error. Even simple examples will take time.</p>
<p>One tool that may help is the <a href="https://rvest.tidyverse.org/articles/articles/selectorgadget.html">SelectorGadget</a>. This allows us to pick and choose the elements that we want, and then gives us the input for <code>html_nodes()</code> (<a href="#fig-selectorgadget">Figure&nbsp;<span>9.10</span></a>).</p>
<div id="fig-selectorgadget" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/uk_pms.png" class="img-fluid figure-img" style="width:75.0%"></p>
<p></p><figcaption class="figure-caption">Figure 9.10: Using the Selector Gadget to identify the tag, as at 13 March 2022.</figcaption><p></p>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in our saved data</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>raw_data <span class="ot">&lt;-</span> <span class="fu">read_html</span>(<span class="st">"pms.html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can parse tags in order</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>parse_data_selector_gadget <span class="ot">&lt;-</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  raw_data <span class="sc">|&gt;</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_nodes</span>(<span class="st">"td:nth-child(3)"</span>) <span class="sc">|&gt;</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">html_text</span>()</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(parse_data_selector_gadget)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "\nSir Robert Walpole(1676–1745)\n"                       
[2] "\nSpencer Compton1st Earl of Wilmington(1673–1743)\n"    
[3] "\nHenry Pelham(1694–1754)\n"                             
[4] "\nThomas Pelham-Holles1st Duke of Newcastle(1693–1768)\n"
[5] "\nWilliam Cavendish4th Duke of Devonshire(1720–1764)\n"  
[6] "\nThomas Pelham-Holles1st Duke of Newcastle(1693–1768)\n"</code></pre>
</div>
</div>
<p>In this case there are a few blank lines that we will need to filter away.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>parsed_data <span class="ot">&lt;-</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">raw_text =</span> parse_data_selector_gadget) <span class="sc">|&gt;</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(raw_text <span class="sc">!=</span> <span class="st">"—</span><span class="sc">\n</span><span class="st">"</span>) <span class="sc">|&gt;</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>raw_text <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">1868</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">1874</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">1880</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">1885</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">1892</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">1979</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">1997</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">2010</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>raw_text <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">National Labour</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">William Pulteney1st Earl of Bath(1684–1764)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">James Waldegrave2nd Earl Waldegrave(1715–1763)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">Edward VII</span><span class="sc">\n\n\n</span><span class="st">1901–1910</span><span class="sc">\n\n</span><span class="st">"</span>,</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>      <span class="st">"</span><span class="sc">\n</span><span class="st">George V</span><span class="sc">\n\n\n</span><span class="st">1910–1936</span><span class="sc">\n\n</span><span class="st">"</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(parsed_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 1
  raw_text                                                  
  &lt;chr&gt;                                                     
1 "\nSir Robert Walpole(1676–1745)\n"                       
2 "\nSpencer Compton1st Earl of Wilmington(1673–1743)\n"    
3 "\nHenry Pelham(1694–1754)\n"                             
4 "\nThomas Pelham-Holles1st Duke of Newcastle(1693–1768)\n"
5 "\nWilliam Cavendish4th Duke of Devonshire(1720–1764)\n"  
6 "\nThomas Pelham-Holles1st Duke of Newcastle(1693–1768)\n"</code></pre>
</div>
</div>
<p>Now that we have the parsed data, we need to clean it to match what we wanted. In particular we want a names column, as well as columns for birth year and death year. We use <code>separate()</code> to take advantage of the fact that it looks like the dates are distinguished by brackets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>initial_clean <span class="ot">&lt;-</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  parsed_data <span class="sc">|&gt;</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">raw_text =</span> <span class="fu">str_remove_all</span>(raw_text, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    raw_text,</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"Name"</span>, <span class="st">"not_name"</span>),</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">("</span>,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> <span class="co"># The remove = FALSE option here means that we</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># keep the original column that we are separating.</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>    not_name,</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"Date"</span>, <span class="st">"all_the_rest"</span>),</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">)"</span>,</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(initial_clean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  raw_text                                           Name  not_n…¹ Date  all_t…²
  &lt;chr&gt;                                              &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;  
1 Sir Robert Walpole(1676–1745)                      Sir … 1676–1… 1676… ""     
2 Spencer Compton1st Earl of Wilmington(1673–1743)   Spen… 1673–1… 1673… ""     
3 Henry Pelham(1694–1754)                            Henr… 1694–1… 1694… ""     
4 Thomas Pelham-Holles1st Duke of Newcastle(1693–17… Thom… 1693–1… 1693… ""     
5 William Cavendish4th Duke of Devonshire(1720–1764) Will… 1720–1… 1720… ""     
6 Thomas Pelham-Holles1st Duke of Newcastle(1693–17… Thom… 1693–1… 1693… ""     
# … with abbreviated variable names ¹​not_name, ²​all_the_rest</code></pre>
</div>
</div>
<p>Finally, we need to clean up the columns.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>initial_clean <span class="ot">&lt;-</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  initial_clean <span class="sc">|&gt;</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> Name,</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"Name"</span>, <span class="st">"Title"</span>),</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"[[:digit:]]"</span>,</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">extra =</span> <span class="st">"merge"</span>,</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"right"</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> Name,</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"Name"</span>, <span class="st">"Title"</span>),</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"MP for"</span>,</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">extra =</span> <span class="st">"merge"</span>,</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"right"</span></span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Name =</span> <span class="fu">str_remove</span>(Name, <span class="st">"</span><span class="sc">\\</span><span class="st">[b</span><span class="sc">\\</span><span class="st">]"</span>))</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(initial_clean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  raw_text                                     Name  Title not_n…¹ Date  all_t…²
  &lt;chr&gt;                                        &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;  
1 Sir Robert Walpole(1676–1745)                Sir … &lt;NA&gt;  1676–1… 1676… ""     
2 Spencer Compton1st Earl of Wilmington(1673–… Spen… &lt;NA&gt;  1673–1… 1673… ""     
3 Henry Pelham(1694–1754)                      Henr… &lt;NA&gt;  1694–1… 1694… ""     
4 Thomas Pelham-Holles1st Duke of Newcastle(1… Thom… &lt;NA&gt;  1693–1… 1693… ""     
5 William Cavendish4th Duke of Devonshire(172… Will… &lt;NA&gt;  1720–1… 1720… ""     
6 Thomas Pelham-Holles1st Duke of Newcastle(1… Thom… &lt;NA&gt;  1693–1… 1693… ""     
# … with abbreviated variable names ¹​not_name, ²​all_the_rest</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>cleaned_data <span class="ot">&lt;-</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  initial_clean <span class="sc">|&gt;</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Name, Date) <span class="sc">|&gt;</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(Date, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"Birth"</span>, <span class="st">"Died"</span>), <span class="at">sep =</span> <span class="st">"–"</span>, <span class="at">remove =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> <span class="co"># The</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># PMs who have died have their birth and death years separated by a hyphen,</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># but we need to be careful with the hyphen as it seems to be a slightly odd</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># type of hyphen and we need to copy/paste it.</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Birth =</span> <span class="fu">str_remove_all</span>(Birth, <span class="st">"born"</span>),</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Birth =</span> <span class="fu">str_trim</span>(Birth)</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> <span class="co"># Alive PMs have slightly different format</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Date) <span class="sc">|&gt;</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Name =</span> <span class="fu">str_remove</span>(Name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)) <span class="sc">|&gt;</span> <span class="co"># Remove some HTML tags that remain</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_at</span>(<span class="fu">vars</span>(Birth, Died), <span class="sc">~</span> <span class="fu">as.integer</span>(.)) <span class="sc">|&gt;</span> <span class="co"># Change birth and death to integers</span></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Age_at_Death =</span> Died <span class="sc">-</span> Birth) <span class="sc">|&gt;</span> <span class="co"># Add column of the number of years they lived</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="co"># Some of the PMs had two goes at it.</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(cleaned_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  Name                 Birth  Died Age_at_Death
  &lt;chr&gt;                &lt;int&gt; &lt;int&gt;        &lt;int&gt;
1 Sir Robert Walpole    1676  1745           69
2 Spencer Compton       1673  1743           70
3 Henry Pelham          1694  1754           60
4 Thomas Pelham-Holles  1693  1768           75
5 William Cavendish     1720  1764           44
6 John Stuart           1713  1792           79</code></pre>
</div>
</div>
<p>Our dataset looks similar to the one that we said we wanted at the start (<a href="#tbl-canadianpmscleanddata">Table&nbsp;<span>9.2</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>cleaned_data <span class="sc">|&gt;</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">|&gt;</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Prime Minister"</span>, <span class="st">"Birth year"</span>, <span class="st">"Death year"</span>, <span class="st">"Age at death"</span>),</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">booktabs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">linesep =</span> <span class="st">""</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="tbl-canadianpmscleanddata" class="anchored">
<table class="table table-sm table-striped">
<caption>Table 9.2: UK Prime Ministers, by how old they were when they died</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Prime Minister</th>
<th style="text-align: right;">Birth year</th>
<th style="text-align: right;">Death year</th>
<th style="text-align: right;">Age at death</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Sir Robert Walpole</td>
<td style="text-align: right;">1676</td>
<td style="text-align: right;">1745</td>
<td style="text-align: right;">69</td>
</tr>
<tr class="even">
<td style="text-align: left;">Spencer Compton</td>
<td style="text-align: right;">1673</td>
<td style="text-align: right;">1743</td>
<td style="text-align: right;">70</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Henry Pelham</td>
<td style="text-align: right;">1694</td>
<td style="text-align: right;">1754</td>
<td style="text-align: right;">60</td>
</tr>
<tr class="even">
<td style="text-align: left;">Thomas Pelham-Holles</td>
<td style="text-align: right;">1693</td>
<td style="text-align: right;">1768</td>
<td style="text-align: right;">75</td>
</tr>
<tr class="odd">
<td style="text-align: left;">William Cavendish</td>
<td style="text-align: right;">1720</td>
<td style="text-align: right;">1764</td>
<td style="text-align: right;">44</td>
</tr>
<tr class="even">
<td style="text-align: left;">John Stuart</td>
<td style="text-align: right;">1713</td>
<td style="text-align: right;">1792</td>
<td style="text-align: right;">79</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>At this point we would like to make a graph that illustrates how long each prime minister lived. If they are still alive then we would like them to run to the end, but we would like to color them differently.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>cleaned_data <span class="sc">|&gt;</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">still_alive =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(Died), <span class="st">"Yes"</span>, <span class="st">"No"</span>),</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Died =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(Died), <span class="fu">as.integer</span>(<span class="dv">2022</span>), Died)</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Name =</span> <span class="fu">as_factor</span>(Name)) <span class="sc">|&gt;</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> Birth,</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">xend =</span> Died,</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> Name,</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">yend =</span> Name,</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> still_alive</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>() <span class="sc">+</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Year of birth"</span>,</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Prime minister"</span>,</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"PM is currently alive"</span>,</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"How long each UK Prime Minister lived, by year of birth"</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="09-gather_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="downloading-multiple-files" class="level3" data-number="9.3.3">
<h3 data-number="9.3.3" class="anchored" data-anchor-id="downloading-multiple-files"><span class="header-section-number">9.3.3</span> Downloading multiple files</h3>
<p>Considering text as data is exciting and opens a lot of different research questions. Many guides assume that we already have a nicely formatted text dataset, but that is rarely actually the case. In this case study we will download files from a few different pages. While we have already seen two examples of web scraping, those were focused on just one page, whereas we often need many. Here we will focus on this iteration. We will use <code>download.file()</code> to do the download, and <code>purrr</code> <span class="citation" data-cites="citepurrr">(<a href="99-references.html#ref-citepurrr" role="doc-biblioref">Henry and Wickham 2020</a>)</span> to apply this function across multiple sites.</p>
<p>The Reserve Bank of Australia (RBA) is Australia’s central bank and sets monetary policy. It has responsibility for setting the cash rate, which is the interest rate used for loans between banks. This interest rate is an especially important one and has a large impact on the other interest rates in the economy. Four times a year – February, May, August, and November – the RBA publishes a statement on monetary policy, and these are available as PDFs. In this example we will download the four statements published in 2021.</p>
<p>First we set-up a dataframe that has the information that we need.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>statements_of_interest <span class="ot">&lt;-</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">address =</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://www.rba.gov.au/publications/smp/2021/nov/pdf/00-overview.pdf"</span>,</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://www.rba.gov.au/publications/smp/2021/aug/pdf/00-overview.pdf"</span>,</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://www.rba.gov.au/publications/smp/2021/may/pdf/00-overview.pdf"</span>,</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://www.rba.gov.au/publications/smp/2021/feb/pdf/00-overview.pdf"</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">local_save_name =</span> <span class="fu">c</span>(</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">"2021-11.pdf"</span>,</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">"2021-08.pdf"</span>,</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">"2021-05.pdf"</span>,</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">"2021-02.pdf"</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>statements_of_interest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  address                                                              local_s…¹
  &lt;chr&gt;                                                                &lt;chr&gt;    
1 https://www.rba.gov.au/publications/smp/2021/nov/pdf/00-overview.pdf 2021-11.…
2 https://www.rba.gov.au/publications/smp/2021/aug/pdf/00-overview.pdf 2021-08.…
3 https://www.rba.gov.au/publications/smp/2021/may/pdf/00-overview.pdf 2021-05.…
4 https://www.rba.gov.au/publications/smp/2021/feb/pdf/00-overview.pdf 2021-02.…
# … with abbreviated variable name ¹​local_save_name</code></pre>
</div>
</div>
<p>We want to apply the function <code>download.files()</code> to these four. To do this we write a function that will download the file, let us know that it was downloaded, wait a polite amount of time, and then go get the next file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>visit_download_and_wait <span class="ot">&lt;-</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(the_address_to_visit, where_to_save_it_locally) {</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">download.file</span>(</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">url =</span> the_address_to_visit,</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">destfile =</span> where_to_save_it_locally</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Done with"</span>, the_address_to_visit, <span class="st">"at"</span>, <span class="fu">Sys.time</span>()))</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="fu">sample</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span>))</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now apply that function to our tibble of URLs and save names using the funtion <code>walk2()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">walk2</span>(</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  statements_of_interest<span class="sc">$</span>address,</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>  statements_of_interest<span class="sc">$</span>local_save_name,</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span> <span class="fu">visit_download_and_wait</span>(.x, .y)</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result is that we have downloaded these four PDFs and saved them to our computer. An alternative to writing these functions ourselves would be use <code>heapsofpapers</code> <span class="citation" data-cites="heapsofpapers">(<a href="99-references.html#ref-heapsofpapers" role="doc-biblioref">Alexander and Mahfouz 2021</a>)</span>, which includes various helpful options for downloading lists of files, especially PDF, CSV, and txt files. For instance, <span class="citation" data-cites="collinsalexander">Collins and Alexander (<a href="99-references.html#ref-collinsalexander" role="doc-biblioref">2022</a>)</span> use this to obtain thousands of PDFs and estimate the extent to which COVID-19 research was reproducible. In the next section we will build on this to discuss getting information from these PDFs.</p>
</section>
</section>
<section id="pdfs" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="pdfs"><span class="header-section-number">9.4</span> PDFs</h2>
<p>PDF files were developed in 1993 by the technology company Adobe and are useful for documents because they are meant to display in a consistent way independent of the environment that created them or the environment in which they are being viewed. A PDF viewed on an iPhone should look the same as on a Android phone, as on a Linux desktop. One feature of PDFs is that they can include a variety of objects, for instance, text, photos, figures, etc. However, this variety can limit the capacity of PDFs to be used directly as data inputs for statistical analysis. The data first needs to be extracted from the PDF.</p>
<p>It is often possible to copy and paste the data from the PDF. This is more likely when the PDF only contains simple text or regular tables. In particular, if the PDF has been created by an application such as Microsoft Word, or another document- or form-creation system, then often the text data can be extracted in this way because they are actually stored as text within the PDF. We begin with that case. But it is not as easy if the text has been stored as an image which is then part of the PDF. This may be the case for PDFs produced through scans or photos of physical documents, and some older document preparation software. We go through that case later.</p>
<p>In contrast to an API, a PDF is usually only produced for human rather than computer consumption. The nice thing about PDFs is that they are static and constant. And it is great that data are available. But the trade-off is that:</p>
<ul>
<li>It is not overly useful to do larger-scale statistical analysis.</li>
<li>We do not know how the PDF was put together so we do not know whether we can trust it.</li>
<li>We cannot manipulate the data to get results that we are interested in.</li>
</ul>
<p>There are two important aspects to keep in mind when extracting data from a PDF:</p>
<ol type="1">
<li>Begin with an end in mind. Planning and then literally sketching out what we want from a final dataset/graph/paper stops us wasting time and keeps us focused.</li>
<li>Start simple, then iterate. The quickest way to make a complicated model is often to first build a simple model and then complicate it. Start with just trying to get one page of the PDF working or even just one line. Then iterate from there.</li>
</ol>
<p>We will start by walking through several examples and then go through a case study where we will gather data on US Total Fertility Rate, by state.</p>
<section id="jane-eyre" class="level3" data-number="9.4.1">
<h3 data-number="9.4.1" class="anchored" data-anchor-id="jane-eyre"><span class="header-section-number">9.4.1</span> Jane Eyre</h3>
<p><a href="#fig-firstpdfexample">Figure&nbsp;<span>9.11</span></a> is a PDF that consists of just the first sentence from Emily Brontë’s novel <em>Jane Eyre</em> taken from Project Gutenberg <span class="citation" data-cites="janeeyre">(<a href="99-references.html#ref-janeeyre" role="doc-biblioref">Brontë 1847</a>)</span>. If we assume that it was saved as “first_example.pdf”, then we can use <code>pdftools</code> <span class="citation" data-cites="pdftools">(<a href="99-references.html#ref-pdftools" role="doc-biblioref">Ooms 2019a</a>)</span> to get the text from this one-page PDF into R.</p>
<div id="fig-firstpdfexample" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="inputs/pdfs/first_example.png" class="img-fluid figure-img" style="width:75.0%"></p>
<p></p><figcaption class="figure-caption">Figure 9.11: First sentence of Jane Eyre</figcaption><p></p>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pdftools)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>first_example <span class="ot">&lt;-</span> <span class="fu">pdf_text</span>(<span class="st">"first_example.pdf"</span>)</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>first_example</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(first_example)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Using poppler version 22.02.0</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "There was no possibility of taking a walk that day.\n"</code></pre>
</div>
</div>
<p>We can see that the PDF has been correctly read in, as a character vector.</p>
<p>We will now try a slightly more complicated example that consists of the first few paragraphs of <em>Jane Eyre</em> (<a href="#fig-secondpdfexample">Figure&nbsp;<span>9.12</span></a>). Also notice that now we have the chapter heading as well.</p>
<div id="fig-secondpdfexample" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="inputs/pdfs/second_example.png" class="img-fluid figure-img" style="width:90.0%"></p>
<p></p><figcaption class="figure-caption">Figure 9.12: First few paragraphs of Jane Eyre</figcaption><p></p>
</figure>
</div>
<p>We use the same function as before.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>second_example <span class="ot">&lt;-</span> pdftools<span class="sc">::</span><span class="fu">pdf_text</span>(<span class="st">"second_example.pdf"</span>)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>second_example</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(second_example)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "CHAPTER I\nThere was no possibility of taking a walk that day. We had been wandering, indeed, in the\nleafless shrubbery an hour in the morning; but since dinner (Mrs. Reed, when there was no\ncompany, dined early) the cold winter wind had brought with it clouds so sombre, and a rain so\npenetrating, that further out-door exercise was now out of the question.\n\nI was glad of it: I never liked long walks, especially on chilly afternoons: dreadful to me was the\ncoming home in the raw twilight, with nipped fingers and toes, and a heart saddened by the\nchidings of Bessie, the nurse, and humbled by the consciousness of my physical inferiority to\nEliza, John, and Georgiana Reed.\n\nThe said Eliza, John, and Georgiana were now clustered round their mama in the drawing-room:\nshe lay reclined on a sofa by the fireside, and with her darlings about her (for the time neither\nquarrelling nor crying) looked perfectly happy. Me, she had dispensed from joining the group;\nsaying, “She regretted to be under the necessity of keeping me at a distance; but that until she\nheard from Bessie, and could discover by her own observation, that I was endeavouring in good\nearnest to acquire a more sociable and childlike disposition, a more attractive and sprightly\nmanner—something lighter, franker, more natural, as it were—she really must exclude me from\nprivileges intended only for contented, happy, little children.”\n\n“What does Bessie say I have done?” I asked.\n\n“Jane, I don’t like cavillers or questioners; besides, there is something truly forbidding in a child\ntaking up her elders in that manner. Be seated somewhere; and until you can speak pleasantly,\nremain silent.”\n\nA breakfast-room adjoined the drawing-room, I slipped in there. It contained a bookcase: I soon\npossessed myself of a volume, taking care that it should be one stored with pictures. I mounted\ninto the window-seat: gathering up my feet, I sat cross-legged, like a Turk; and, having drawn the\nred moreen curtain nearly close, I was shrined in double retirement.\n\nFolds of scarlet drapery shut in my view to the right hand; to the left were the clear panes of\nglass, protecting, but not separating me from the drear November day. At intervals, while\nturning over the leaves of my book, I studied the aspect of that winter afternoon. Afar, it offered\na pale blank of mist and cloud; near a scene of wet lawn and storm-beat shrub, with ceaseless\nrain sweeping away wildly before a long and lamentable blast.\n"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
</div>
<p>Again, we have a character vector. The end of each line is signaled by “\n”, but other than that it looks pretty good. Finally, we consider the first two pages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>third_example <span class="ot">&lt;-</span> pdftools<span class="sc">::</span><span class="fu">pdf_text</span>(<span class="st">"third_example.pdf"</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>third_example</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(third_example)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "CHAPTER I\nThere was no possibility of taking a walk that day. We had been wandering, indeed, in the\nleafless shrubbery an hour in the morning; but since dinner (Mrs. Reed, when there was no\ncompany, dined early) the cold winter wind had brought with it clouds so sombre, and a rain so\npenetrating, that further out-door exercise was now out of the question.\n\nI was glad of it: I never liked long walks, especially on chilly afternoons: dreadful to me was the\ncoming home in the raw twilight, with nipped fingers and toes, and a heart saddened by the\nchidings of Bessie, the nurse, and humbled by the consciousness of my physical inferiority to\nEliza, John, and Georgiana Reed.\n\nThe said Eliza, John, and Georgiana were now clustered round their mama in the drawing-room:\nshe lay reclined on a sofa by the fireside, and with her darlings about her (for the time neither\nquarrelling nor crying) looked perfectly happy. Me, she had dispensed from joining the group;\nsaying, “She regretted to be under the necessity of keeping me at a distance; but that until she\nheard from Bessie, and could discover by her own observation, that I was endeavouring in good\nearnest to acquire a more sociable and childlike disposition, a more attractive and sprightly\nmanner—something lighter, franker, more natural, as it were—she really must exclude me from\nprivileges intended only for contented, happy, little children.”\n\n“What does Bessie say I have done?” I asked.\n\n“Jane, I don’t like cavillers or questioners; besides, there is something truly forbidding in a child\ntaking up her elders in that manner. Be seated somewhere; and until you can speak pleasantly,\nremain silent.”\n\nA breakfast-room adjoined the drawing-room, I slipped in there. It contained a bookcase: I soon\npossessed myself of a volume, taking care that it should be one stored with pictures. I mounted\ninto the window-seat: gathering up my feet, I sat cross-legged, like a Turk; and, having drawn the\nred moreen curtain nearly close, I was shrined in double retirement.\n\nFolds of scarlet drapery shut in my view to the right hand; to the left were the clear panes of\nglass, protecting, but not separating me from the drear November day. At intervals, while\nturning over the leaves of my book, I studied the aspect of that winter afternoon. Afar, it offered\na pale blank of mist and cloud; near a scene of wet lawn and storm-beat shrub, with ceaseless\nrain sweeping away wildly before a long and lamentable blast.\n\nI returned to my book—Bewick’s History of British Birds: the letterpress thereof I cared little\nfor, generally speaking; and yet there were certain introductory pages that, child as I was, I could\nnot pass quite as a blank. They were those which treat of the haunts of sea-fowl; of “the solitary\nrocks and promontories” by them only inhabited; of the coast of Norway, studded with isles from\nits southern extremity, the Lindeness, or Naze, to the North Cape—\n\n“Where the Northern Ocean, in vast whirls,\nBoils round the naked, melancholy isles\n"
[2] "Of farthest Thule; and the Atlantic surge\nPours in among the stormy Hebrides.”\n\nNor could I pass unnoticed the suggestion of the bleak shores of Lapland, Siberia, Spitzbergen,\nNova Zembla, Iceland, Greenland, with “the vast sweep of the Arctic Zone, and those forlorn\nregions of dreary space,—that reservoir of frost and snow, where firm fields of ice, the\naccumulation of centuries of winters, glazed in Alpine heights above heights, surround the pole,\nand concentre the multiplied rigours of extreme cold.” Of these death-white realms I formed an\nidea of my own: shadowy, like all the half-comprehended notions that float dim through\nchildren’s brains, but strangely impressive. The words in these introductory pages connected\nthemselves with the succeeding vignettes, and gave significance to the rock standing up alone in\na sea of billow and spray; to the broken boat stranded on a desolate coast; to the cold and ghastly\nmoon glancing through bars of cloud at a wreck just sinking.\n\nI cannot tell what sentiment haunted the quite solitary churchyard, with its inscribed headstone;\nits gate, its two trees, its low horizon, girdled by a broken wall, and its newly-risen crescent,\nattesting the hour of eventide.\n\nThe two ships becalmed on a torpid sea, I believed to be marine phantoms.\n\nThe fiend pinning down the thief’s pack behind him, I passed over quickly: it was an object of\nterror.\n\nSo was the black horned thing seated aloof on a rock, surveying a distant crowd surrounding a\ngallows.\n\nEach picture told a story; mysterious often to my undeveloped understanding and imperfect\nfeelings, yet ever profoundly interesting: as interesting as the tales Bessie sometimes narrated on\nwinter evenings, when she chanced to be in good humour; and when, having brought her ironing-\ntable to the nursery hearth, she allowed us to sit about it, and while she got up Mrs. Reed’s lace\nfrills, and crimped her nightcap borders, fed our eager attention with passages of love and\nadventure taken from old fairy tales and other ballads; or (as at a later period I discovered) from\nthe pages of Pamela, and Henry, Earl of Moreland.\n\nWith Bewick on my knee, I was then happy: happy at least in my way. I feared nothing but\ninterruption, and that came too soon. The breakfast-room door opened.\n\n“Boh! Madam Mope!” cried the voice of John Reed; then he paused: he found the room\napparently empty.\n\n“Where the dickens is she!” he continued. “Lizzy! Georgy! (calling to his sisters) Joan is not\nhere: tell mama she is run out into the rain—bad animal!”\n\n“It is well I drew the curtain,” thought I; and I wished fervently he might not discover my hiding-\nplace: nor would John Reed have found it out himself; he was not quick either of vision or\nconception; but Eliza just put her head in at the door, and said at once—\n"                                                                                                                                                                                                            </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
</div>
<p>Notice that the first page is the first element of the character vector, and the second page is the second element. As we are most familiar with rectangular data, we will try to get it into that format as quickly as possible. And then we can use our regular <code>tidyverse</code> functions to deal with it.</p>
<p>First we want to convert the character vector into a tibble. At this point we may like to add page numbers as well.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>jane_eyre <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">raw_text =</span> third_example,</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">page_number =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then want to separate the lines so that each line is an observation. We can do that by looking for “\n” remembering that we need to escape the backslash as it is a special character.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>jane_eyre <span class="ot">&lt;-</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate_rows</span>(jane_eyre, raw_text, <span class="at">sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">n"</span>, <span class="at">convert =</span> <span class="cn">FALSE</span>)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>jane_eyre</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 93 × 2
   raw_text                                                              page_…¹
   &lt;chr&gt;                                                                   &lt;int&gt;
 1 "CHAPTER I"                                                                 1
 2 "There was no possibility of taking a walk that day. We had been wan…       1
 3 "leafless shrubbery an hour in the morning; but since dinner (Mrs. R…       1
 4 "company, dined early) the cold winter wind had brought with it clou…       1
 5 "penetrating, that further out-door exercise was now out of the ques…       1
 6 ""                                                                          1
 7 "I was glad of it: I never liked long walks, especially on chilly af…       1
 8 "coming home in the raw twilight, with nipped fingers and toes, and …       1
 9 "chidings of Bessie, the nurse, and humbled by the consciousness of …       1
10 "Eliza, John, and Georgiana Reed."                                          1
# … with 83 more rows, and abbreviated variable name ¹​page_number
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
</div>
</section>
<section id="us-total-fertility-rate" class="level3" data-number="9.4.2">
<h3 data-number="9.4.2" class="anchored" data-anchor-id="us-total-fertility-rate"><span class="header-section-number">9.4.2</span> US Total Fertility Rate</h3>
<p>The US Department of Health and Human Services Vital Statistics Report provides information about the total fertility rate (the average number of births per woman if women experience the current age-specific fertility rates throughout their reproductive years) for each state for nineteen years. The US persists in only making this data available in PDFs, which hinders research. But we can use the approaches above to get the data into a nice dataset.</p>
<p>For instance, in the case of the year 2000 the table that we are interested in is on page 40 of a PDF that is available <a href="https://www.cdc.gov/nchs/data/nvsr/nvsr50/nvsr50_05.pdf">here</a>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> The column of interest is labelled: “Total fertility rate” (<a href="#fig-dhsexample">Figure&nbsp;<span>9.13</span></a>).</p>
<div id="fig-dhsexample" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/dhs_example.png" class="img-fluid figure-img" style="width:90.0%"></p>
<p></p><figcaption class="figure-caption">Figure 9.13: Example Vital Statistics Report, from 2000</figcaption><p></p>
</figure>
</div>
<p>The first step when getting data out of a PDF is to sketch out what we eventually want. A PDF typically contains a lot of information, and so it is important to be clear about what you need. This helps keep you focused, and prevents scope creep, but it is also helpful when thinking about data checks. We literally write down on paper what we have in mind. In this case, what is needed is a table with a column for state, year and total fertility rate (TFR) (<a href="#fig-tfrdesired">Figure&nbsp;<span>9.14</span></a>).</p>
<div id="fig-tfrdesired" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/tfr_dataset_sketch.png" class="img-fluid figure-img" style="width:40.0%"></p>
<p></p><figcaption class="figure-caption">Figure 9.14: Planned dataset of TFR for each year and US state</figcaption><p></p>
</figure>
</div>
<p>There are 19 different PDFs, and we are interested in a particular column in a particular table in each of them. Unfortunately, there is nothing magical about what is coming. This first step requires finding each PDF online, working out the link for each, and manually searching for the page and column name that is of interest. In the end, this looks like <a href="#tbl-dhslinks">Table&nbsp;<span>9.3</span></a>.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-dhslinks" class="anchored">
<table class="table table-sm table-striped">
<caption>Table 9.3: First ten rows of a dataset of economic indicators for Australia, Ethiopia, India, and the US</caption>
<colgroup>
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 21%">
<col style="width: 61%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">Year</th>
<th style="text-align: right;">Page</th>
<th style="text-align: right;">Table</th>
<th style="text-align: left;">Column</th>
<th style="text-align: left;">URL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">2000</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr50/nvsr50_05.pdf</td>
</tr>
<tr class="even">
<td style="text-align: right;">2001</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr51/nvsr51_02.pdf</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2002</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr52/nvsr52_10.pdf</td>
</tr>
<tr class="even">
<td style="text-align: right;">2003</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">10</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr54/nvsr54_02.pdf</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2004</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">11</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr55/nvsr55_01.pdf</td>
</tr>
<tr class="even">
<td style="text-align: right;">2005</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">11</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr56/nvsr56_06.pdf</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2006</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">11</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr57/nvsr57_07.pdf</td>
</tr>
<tr class="even">
<td style="text-align: right;">2007</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">11</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr58/nvsr58_24.pdf</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2008</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr59/nvsr59_01.pdf</td>
</tr>
<tr class="even">
<td style="text-align: right;">2009</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr60/nvsr60_01.pdf</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2010</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr61/nvsr61_01.pdf</td>
</tr>
<tr class="even">
<td style="text-align: right;">2011</td>
<td style="text-align: right;">40</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr62/nvsr62_01.pdf</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2012</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr62/nvsr62_09.pdf</td>
</tr>
<tr class="even">
<td style="text-align: right;">2013</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr64/nvsr64_01.pdf</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2014</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr64/nvsr64_12.pdf</td>
</tr>
<tr class="even">
<td style="text-align: right;">2015</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr66/nvsr66_01.pdf</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2016</td>
<td style="text-align: right;">29</td>
<td style="text-align: right;">8</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr67/nvsr67_01.pdf</td>
</tr>
<tr class="even">
<td style="text-align: right;">2016</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">8</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr67/nvsr67_01.pdf</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2017</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr67/nvsr67_08-508.pdf</td>
</tr>
<tr class="even">
<td style="text-align: right;">2017</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr67/nvsr67_08-508.pdf</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2018</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">12</td>
<td style="text-align: left;">Total fertility rate</td>
<td style="text-align: left;">https://www.cdc.gov/nchs/data/nvsr/nvsr68/nvsr68_13-508.pdf</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The first step is to get some code that works for one of them. We step through the code in a lot more detail than normal because we are going to use these pieces a lot.</p>
<p>We will choose the year 2000. We first download and save the PDF using <code>download.file()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">url =</span> summary_tfr_dataset<span class="sc">$</span>url[<span class="dv">1</span>],</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">destfile =</span> <span class="st">"year_2000.pdf"</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then read the PDF in as a character vector using <code>pdf_text()</code> from <code>pdftools</code>. And then convert it to a tibble, so that we can use familiar verbs on it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pdftools)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>dhs_2000 <span class="ot">&lt;-</span> <span class="fu">pdf_text</span>(<span class="st">"year_2000.pdf"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>dhs_2000_tibble <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">raw_data =</span> dhs_2000)</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dhs_2000_tibble)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 1
  raw_data                                                                      
  &lt;chr&gt;                                                                         
1 "Volume 50, Number 5                                                         …
2 "2   National Vital Statistics Report, Vol. 50, No. 5, February 12, 2002\n\n\…
3 "                                                                            …
4 "4   National Vital Statistics Report, Vol. 50, No. 5, February 12, 2002\n\n\…
5 "                                                                            …
6 "6   National Vital Statistics Report, Vol. 50, No. 5, February 12, 2002\n\n …</code></pre>
</div>
</div>
<p>Grab the page that is of interest (remembering that each page is a element of the character vector, hence a row in the tibble).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>dhs_2000_relevant_page <span class="ot">&lt;-</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  dhs_2000_tibble <span class="sc">|&gt;</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(summary_tfr_dataset<span class="sc">$</span>page[<span class="dv">1</span>])</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dhs_2000_relevant_page)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  raw_data                                                                      
  &lt;chr&gt;                                                                         
1 "40 National Vital Statistics Report, Vol. 50, No. 5, Revised May 15, 20022\n…</code></pre>
</div>
</div>
<p>Now we want to separate the rows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>dhs_2000_separate_rows <span class="ot">&lt;-</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  dhs_2000_relevant_page <span class="sc">|&gt;</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate_rows</span>(raw_data, <span class="at">sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">n"</span>, <span class="at">convert =</span> <span class="cn">FALSE</span>)</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dhs_2000_separate_rows)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 1
  raw_data                                                                      
  &lt;chr&gt;                                                                         
1 "40 National Vital Statistics Report, Vol. 50, No. 5, Revised May 15, 20022"  
2 ""                                                                            
3 "Table 10. Number of births, birth rates, fertility rates, total fertility ra…
4 "United States, each State and territory, 2000"                               
5 "[By place of residence. Birth rates are live births per 1,000 estimated popu…
6 "estimated in each area; total fertility rates are sums of birth rates for 5-…</code></pre>
</div>
</div>
<p>Now we are searching for patterns that we can use. Let us look at the first ten lines of content (ignoring aspects such as headings and page numbers at the top of the page).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>dhs_2000_separate_rows[<span class="dv">13</span><span class="sc">:</span><span class="dv">22</span>, ] <span class="sc">|&gt;</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">raw_data =</span> <span class="fu">str_remove</span>(raw_data, <span class="st">"</span><span class="sc">\\</span><span class="st">.{40}"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 1
   raw_data                                                                     
   &lt;chr&gt;                                                                        
 1 "                                  State                                    …
 2 "                                                                           …
 3 "                                                                           …
 4 ""                                                                           
 5 ""                                                                           
 6 "United States 1 ..............          4,058,814   14.7      67.5      2,1…
 7 ""                                                                           
 8 "Alabama .......................           63,299    14.4      65.0      2,0…
 9 "Alaska ...........................         9,974    16.0      74.6      2,4…
10 "Arizona .........................         85,273    17.5      84.4      2,6…</code></pre>
</div>
</div>
<p>And now at just one line.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>dhs_2000_separate_rows[<span class="dv">20</span>, ] <span class="sc">|&gt;</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">raw_data =</span> <span class="fu">str_remove</span>(raw_data, <span class="st">"</span><span class="sc">\\</span><span class="st">.{40}"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  raw_data                                                                      
  &lt;chr&gt;                                                                         
1 Alabama .......................           63,299    14.4      65.0      2,021…</code></pre>
</div>
</div>
<p>It does not get much better than this:</p>
<ol type="1">
<li>We have dots separating the states from the data.</li>
<li>We have a space between each of the columns.</li>
</ol>
<p>We can now separate this in to separate columns. First, we want to match on when there is at least two dots (remembering that the dot is a special character and so needs to be escaped).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>dhs_2000_separate_columns <span class="ot">&lt;-</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  dhs_2000_separate_rows <span class="sc">|&gt;</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> raw_data,</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"state"</span>, <span class="st">"data"</span>),</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.{2,}"</span>,</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove =</span> <span class="cn">FALSE</span>,</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"right"</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>dhs_2000_separate_columns[<span class="dv">18</span><span class="sc">:</span><span class="dv">28</span>, ] <span class="sc">|&gt;</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 2
   state                   data                                                 
   &lt;chr&gt;                   &lt;chr&gt;                                                
 1 "United States 1 "      "          4,058,814   14.7      67.5      2,130.0  …
 2 ""                       &lt;NA&gt;                                                
 3 "Alabama "              "           63,299    14.4      65.0      2,021.0   …
 4 "Alaska "               "         9,974    16.0      74.6      2,437.0      …
 5 "Arizona "              "         85,273    17.5      84.4      2,652.5     …
 6 "Arkansas "             "          37,783    14.7      69.1      2,140.0    …
 7 "California "           "        531,959    15.8      70.7      2,186.0     …
 8 "Colorado "             "          65,438    15.8      73.1      2,356.5    …
 9 "Connecticut "          "           43,026    13.0      61.2      1,931.5   …
10 "Delaware "             "           11,051    14.5      63.5      2,014.0   …
11 "District of Columbia " "                7,666    14.8      63.0      1,975.…</code></pre>
</div>
</div>
<!-- We get the expected warnings about the top and the bottom as they do not have multiple dots. (Another option here is to use `pdf_data()` which would allow us to use location rather than delimiters.) -->
<p>We can now separate the data based on spaces. There is an inconsistent number of spaces, so we first squish any example of more than one space into just one.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>dhs_2000_separate_data <span class="ot">&lt;-</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  dhs_2000_separate_columns <span class="sc">|&gt;</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">str_squish</span>(data)) <span class="sc">|&gt;</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> data,</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">into =</span> <span class="fu">c</span>(</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">"number_of_births"</span>,</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">"birth_rate"</span>,</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"fertility_rate"</span>,</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"TFR"</span>,</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">"teen_births_all"</span>,</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">"teen_births_15_17"</span>,</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">"teen_births_18_19"</span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">s"</span>,</span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a>dhs_2000_separate_data[<span class="dv">18</span><span class="sc">:</span><span class="dv">28</span>, ] <span class="sc">|&gt;</span></span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>raw_data, <span class="sc">-</span>data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 8
   state                   numbe…¹ birth…² ferti…³ TFR   teen_…⁴ teen_…⁵ teen_…⁶
   &lt;chr&gt;                   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  
 1 "United States 1 "      4,058,… 14.7    67.5    2,13… 48.5    27.4    79.2   
 2 ""                      &lt;NA&gt;    &lt;NA&gt;    &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;    &lt;NA&gt;   
 3 "Alabama "              63,299  14.4    65.0    2,02… 62.9    37.9    97.3   
 4 "Alaska "               9,974   16.0    74.6    2,43… 42.4    23.6    69.4   
 5 "Arizona "              85,273  17.5    84.4    2,65… 69.1    41.1    111.3  
 6 "Arkansas "             37,783  14.7    69.1    2,14… 68.5    36.7    114.1  
 7 "California "           531,959 15.8    70.7    2,18… 48.5    28.6    75.6   
 8 "Colorado "             65,438  15.8    73.1    2,35… 49.2    28.6    79.8   
 9 "Connecticut "          43,026  13.0    61.2    1,93… 31.9    16.9    56.3   
10 "Delaware "             11,051  14.5    63.5    2,01… 51.6    30.5    80.2   
11 "District of Columbia " 7,666   14.8    63.0    1,97… 80.7    60.7    101.8  
# … with abbreviated variable names ¹​number_of_births, ²​birth_rate,
#   ³​fertility_rate, ⁴​teen_births_all, ⁵​teen_births_15_17, ⁶​teen_births_18_19</code></pre>
</div>
</div>
<p>This is all looking fairly great. The only thing left is to clean up.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>dhs_2000_cleaned <span class="ot">&lt;-</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  dhs_2000_separate_data <span class="sc">|&gt;</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, TFR) <span class="sc">|&gt;</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">18</span><span class="sc">:</span><span class="dv">71</span>) <span class="sc">|&gt;</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="dv">2000</span>)</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>dhs_2000_cleaned</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 54 × 3
   state              TFR      year
   &lt;chr&gt;              &lt;chr&gt;   &lt;dbl&gt;
 1 "United States 1 " 2,130.0  2000
 2 ""                 &lt;NA&gt;     2000
 3 "Alabama "         2,021.0  2000
 4 "Alaska "          2,437.0  2000
 5 "Arizona "         2,652.5  2000
 6 "Arkansas "        2,140.0  2000
 7 "California "      2,186.0  2000
 8 "Colorado "        2,356.5  2000
 9 "Connecticut "     1,931.5  2000
10 "Delaware "        2,014.0  2000
# … with 44 more rows
# ℹ Use `print(n = ...)` to see more rows</code></pre>
</div>
</div>
<p>And we are done for that year. Now we want to take these pieces, put them into a function and then run that function over all 19 years. The first part is downloading each of the 19 PDFs that we need. We are going to build on the code that we used before, which was:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(<span class="at">url =</span> summary_tfr_dataset<span class="sc">$</span>url[<span class="dv">1</span>], <span class="at">destfile =</span> <span class="st">"year_2000.pdf"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To modify this we need:</p>
<ol type="1">
<li>To have it iterate through each of the lines in the dataset that contains our CSVs (i.e.&nbsp;where it says 1, we want 1, then 2, then 3, etc.).</li>
<li>Where it has a filename, we need it to iterate through our desired filenames (i.e.&nbsp;“year_2000”, then “year_2001”, then “year_2002”, etc).</li>
<li>We would like for it to do all of this in a way that is a little robust to errors. For instance, if one of the URLs is wrong or the internet drops out then we would like it to just move onto the next PDF, and then warn us at the end that it missed one, not to stop. (This does not really matter because it is only 19 files, but it is easy to find oneself doing this for thousands of files.)</li>
</ol>
<p>We will <code>walk2()</code> from <code>purrr</code> for this iteration <span class="citation" data-cites="citepurrr">(<a href="99-references.html#ref-citepurrr" role="doc-biblioref">Henry and Wickham 2020</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>summary_tfr_dataset <span class="ot">&lt;-</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>  summary_tfr_dataset <span class="sc">|&gt;</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pdf_name =</span> <span class="fu">paste0</span>(<span class="st">"dhs/year_"</span>, year, <span class="st">".pdf"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="fu">walk2</span>(</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  summary_tfr_dataset<span class="sc">$</span>url,</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  summary_tfr_dataset<span class="sc">$</span>pdf_name,</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">safely</span>(<span class="sc">~</span> <span class="fu">download.file</span>(.x, .y))</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we take <code>download.file()</code> and pass it two arguments: <code>.x</code> and <code>.y</code>. Then <code>walk2()</code> applies that function to the inputs that we give it, in this case the URLs columns is the <code>.x</code> and the pdf_names column is the <code>.y</code>. Finally, <code>safely()</code> means that if there are any failures then it just moves onto the next file instead of throwing an error.</p>
<p>We now have each of the PDFs saved and we can move onto getting the data from them.</p>
<p>Now we need to get the data from the PDFs. As before, we are going to build on the code that we used before. That code (overly condensed) was:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pdftools)</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>dhs_2000 <span class="ot">&lt;-</span> <span class="fu">pdf_text</span>(<span class="st">"year_2000.pdf"</span>)</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>dhs_2000 <span class="ot">&lt;-</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">raw_data =</span> dhs_2000) <span class="sc">|&gt;</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(summary_tfr_dataset<span class="sc">$</span>page[<span class="dv">1</span>]) <span class="sc">|&gt;</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate_rows</span>(raw_data, <span class="at">sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">n"</span>, <span class="at">convert =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(</span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> raw_data,</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"state"</span>, <span class="st">"data"</span>),</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.{2,}"</span>,</span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">str_squish</span>(data)) <span class="sc">|&gt;</span></span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(</span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> data,</span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">into =</span> <span class="fu">c</span>(</span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">"number_of_births"</span>,</span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">"birth_rate"</span>,</span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a>      <span class="st">"fertility_rate"</span>,</span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a>      <span class="st">"TFR"</span>,</span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a>      <span class="st">"teen_births_all"</span>,</span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">"teen_births_15_17"</span>,</span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">"teen_births_18_19"</span></span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">s"</span>,</span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, TFR) <span class="sc">|&gt;</span></span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">18</span><span class="sc">:</span><span class="dv">71</span>) <span class="sc">|&gt;</span></span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="dv">2000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first thing that we want to iterate is the argument to <code>pdf_text()</code>, then the number in <code>slice()</code> will also need to change (that is doing the work to get only the page that we are interested in).</p>
<p>Two aspects are hardcoded, and these may need to be updated. In particular:</p>
<ol type="1">
<li><code>separate()</code> only works if each of the tables has the same columns in the same order; and</li>
<li><code>slice()</code> (which restricts the data to just the states) only works in this one case because it references specific lines, which may differ between years.</li>
</ol>
<p>Finally, in the code written for the one-year, we add the year only at the end, whereas to do it for multiple years we would need to bring that up earlier in the process.</p>
<p>We will start by writing a function that will go through all the files, grab the data, get the page of interest, and then expand the rows. We will then use <code>pmap_dfr()</code> from <code>purrr</code> to apply that function to all of the PDFs and to output a tibble.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pdftools)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>get_pdf_convert_to_tibble <span class="ot">&lt;-</span> <span class="cf">function</span>(pdf_name, page, year) {</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>  dhs_table_of_interest <span class="ot">&lt;-</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">raw_data =</span> <span class="fu">pdf_text</span>(pdf_name)) <span class="sc">|&gt;</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(page) <span class="sc">|&gt;</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">separate_rows</span>(raw_data, <span class="at">sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">n"</span>, <span class="at">convert =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">separate</span>(</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">col =</span> raw_data,</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"state"</span>, <span class="st">"data"</span>),</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">sep =</span> <span class="st">"[�|</span><span class="sc">\\</span><span class="st">.]</span><span class="sc">\\</span><span class="st">s+(?=[[:digit:]])"</span>,</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> <span class="fu">str_squish</span>(data),</span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">year_of_data =</span> year</span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Done with"</span>, year))</span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dhs_table_of_interest)</span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a>raw_dhs_data <span class="ot">&lt;-</span></span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmap_dfr</span>(</span>
<span id="cb120-28"><a href="#cb120-28" aria-hidden="true" tabindex="-1"></a>    summary_tfr_dataset <span class="sc">|&gt;</span></span>
<span id="cb120-29"><a href="#cb120-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(pdf_name, page, year),</span>
<span id="cb120-30"><a href="#cb120-30" aria-hidden="true" tabindex="-1"></a>    get_pdf_convert_to_tibble</span>
<span id="cb120-31"><a href="#cb120-31" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Done with 2000"
[1] "Done with 2001"
[1] "Done with 2002"
[1] "Done with 2003"
[1] "Done with 2004"
[1] "Done with 2005"
[1] "Done with 2006"
[1] "Done with 2007"
[1] "Done with 2008"
[1] "Done with 2009"
[1] "Done with 2010"
[1] "Done with 2011"
[1] "Done with 2012"
[1] "Done with 2013"
[1] "Done with 2014"
[1] "Done with 2015"
[1] "Done with 2016"
[1] "Done with 2016"
[1] "Done with 2017"
[1] "Done with 2017"
[1] "Done with 2018"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(raw_dhs_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  raw_data                                                   state data  year_…¹
  &lt;chr&gt;                                                      &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;
1 "40 National Vital Statistics Report, Vol. 50, No. 5, Rev… "40 … 50, …    2000
2 ""                                                         ""    &lt;NA&gt;     2000
3 "Table 10. Number of births, birth rates, fertility rates… "Tab… &lt;NA&gt;     2000
4 "United States, each State and territory, 2000"            "Uni… &lt;NA&gt;     2000
5 "[By place of residence. Birth rates are live births per … "[By… &lt;NA&gt;     2000
6 "estimated in each area; total fertility rates are sums o… "est… &lt;NA&gt;     2000
# … with abbreviated variable name ¹​year_of_data</code></pre>
</div>
</div>
<p>Now we need to clean up the state names and then filter on them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Alabama"</span>,</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Alaska"</span>,</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Arizona"</span>,</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Arkansas"</span>,</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"California"</span>,</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Colorado"</span>,</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Connecticut"</span>,</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Delaware"</span>,</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Florida"</span>,</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Georgia"</span>,</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Hawaii"</span>,</span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Idaho"</span>,</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Illinois"</span>,</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Indiana"</span>,</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Iowa"</span>,</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Kansas"</span>,</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Kentucky"</span>,</span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Louisiana"</span>,</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Maine"</span>,</span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Maryland"</span>,</span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Massachusetts"</span>,</span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Michigan"</span>,</span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Minnesota"</span>,</span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Mississippi"</span>,</span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Missouri"</span>,</span>
<span id="cb124-27"><a href="#cb124-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Montana"</span>,</span>
<span id="cb124-28"><a href="#cb124-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Nebraska"</span>,</span>
<span id="cb124-29"><a href="#cb124-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Nevada"</span>,</span>
<span id="cb124-30"><a href="#cb124-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"New Hampshire"</span>,</span>
<span id="cb124-31"><a href="#cb124-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"New Jersey"</span>,</span>
<span id="cb124-32"><a href="#cb124-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"New Mexico"</span>,</span>
<span id="cb124-33"><a href="#cb124-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"New York"</span>,</span>
<span id="cb124-34"><a href="#cb124-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"North Carolina"</span>,</span>
<span id="cb124-35"><a href="#cb124-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"North Dakota"</span>,</span>
<span id="cb124-36"><a href="#cb124-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Ohio"</span>,</span>
<span id="cb124-37"><a href="#cb124-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Oklahoma"</span>,</span>
<span id="cb124-38"><a href="#cb124-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Oregon"</span>,</span>
<span id="cb124-39"><a href="#cb124-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pennsylvania"</span>,</span>
<span id="cb124-40"><a href="#cb124-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Rhode Island"</span>,</span>
<span id="cb124-41"><a href="#cb124-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"South Carolina"</span>,</span>
<span id="cb124-42"><a href="#cb124-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">"South Dakota"</span>,</span>
<span id="cb124-43"><a href="#cb124-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Tennessee"</span>,</span>
<span id="cb124-44"><a href="#cb124-44" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Texas"</span>,</span>
<span id="cb124-45"><a href="#cb124-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Utah"</span>,</span>
<span id="cb124-46"><a href="#cb124-46" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Vermont"</span>,</span>
<span id="cb124-47"><a href="#cb124-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Virginia"</span>,</span>
<span id="cb124-48"><a href="#cb124-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Washington"</span>,</span>
<span id="cb124-49"><a href="#cb124-49" aria-hidden="true" tabindex="-1"></a>  <span class="st">"West Virginia"</span>,</span>
<span id="cb124-50"><a href="#cb124-50" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Wisconsin"</span>,</span>
<span id="cb124-51"><a href="#cb124-51" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Wyoming"</span>,</span>
<span id="cb124-52"><a href="#cb124-52" aria-hidden="true" tabindex="-1"></a>  <span class="st">"District of Columbia"</span></span>
<span id="cb124-53"><a href="#cb124-53" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb124-54"><a href="#cb124-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-55"><a href="#cb124-55" aria-hidden="true" tabindex="-1"></a>raw_dhs_data <span class="ot">&lt;-</span></span>
<span id="cb124-56"><a href="#cb124-56" aria-hidden="true" tabindex="-1"></a>  raw_dhs_data <span class="sc">|&gt;</span></span>
<span id="cb124-57"><a href="#cb124-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb124-58"><a href="#cb124-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">str_remove_all</span>(state, <span class="st">"</span><span class="sc">\\</span><span class="st">."</span>),</span>
<span id="cb124-59"><a href="#cb124-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">str_remove_all</span>(state, <span class="st">"�"</span>),</span>
<span id="cb124-60"><a href="#cb124-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">str_remove_all</span>(state, <span class="st">"\u0008"</span>),</span>
<span id="cb124-61"><a href="#cb124-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">str_replace_all</span>(state, <span class="st">"United States 1"</span>, <span class="st">"United States"</span>),</span>
<span id="cb124-62"><a href="#cb124-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">str_replace_all</span>(state, <span class="st">"United States1"</span>, <span class="st">"United States"</span>),</span>
<span id="cb124-63"><a href="#cb124-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">str_replace_all</span>(state, <span class="st">"United States 2"</span>, <span class="st">"United States"</span>),</span>
<span id="cb124-64"><a href="#cb124-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">str_replace_all</span>(state, <span class="st">"United States2"</span>, <span class="st">"United States"</span>),</span>
<span id="cb124-65"><a href="#cb124-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> <span class="fu">str_replace_all</span>(state, <span class="st">"United States²"</span>, <span class="st">"United States"</span>),</span>
<span id="cb124-66"><a href="#cb124-66" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb124-67"><a href="#cb124-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">str_squish</span>(state)) <span class="sc">|&gt;</span></span>
<span id="cb124-68"><a href="#cb124-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(state <span class="sc">%in%</span> states)</span>
<span id="cb124-69"><a href="#cb124-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-70"><a href="#cb124-70" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(raw_dhs_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  raw_data                                                   state data  year_…¹
  &lt;chr&gt;                                                      &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;
1 Alabama .................................................… Alab… 63,2…    2000
2 Alaska ..................................................… Alas… 9,97…    2000
3 Arizona .................................................… Ariz… 85,2…    2000
4 Arkansas ................................................… Arka… 37,7…    2000
5 California ..............................................… Cali… 531,…    2000
6 Colorado ................................................… Colo… 65,4…    2000
# … with abbreviated variable name ¹​year_of_data</code></pre>
</div>
</div>
<p>The next step is to separate the data and get the correct column from it. We are going to separate based on spaces once it is cleaned up.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>raw_dhs_data <span class="ot">&lt;-</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>  raw_dhs_data <span class="sc">|&gt;</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">str_remove_all</span>(data, <span class="st">"</span><span class="sc">\\</span><span class="st">*"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">into =</span> <span class="fu">c</span>(</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">"col_1"</span>,</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">"col_2"</span>,</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"col_3"</span>,</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"col_4"</span>,</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">"col_5"</span>,</span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">"col_6"</span>,</span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">"col_7"</span>,</span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">"col_8"</span>,</span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">"col_9"</span>,</span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">"col_10"</span></span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">" "</span>,</span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(raw_dhs_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 14
  raw_data     state data  col_1 col_2 col_3 col_4 col_5 col_6 col_7 col_8 col_9
  &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
1 Alabama ...… Alab… 63,2… 63,2… 14.4  65.0  2,02… 62.9  37.9  97.3  &lt;NA&gt;  &lt;NA&gt; 
2 Alaska ....… Alas… 9,97… 9,974 16.0  74.6  2,43… 42.4  23.6  69.4  &lt;NA&gt;  &lt;NA&gt; 
3 Arizona ...… Ariz… 85,2… 85,2… 17.5  84.4  2,65… 69.1  41.1  111.3 &lt;NA&gt;  &lt;NA&gt; 
4 Arkansas ..… Arka… 37,7… 37,7… 14.7  69.1  2,14… 68.5  36.7  114.1 &lt;NA&gt;  &lt;NA&gt; 
5 California … Cali… 531,… 531,… 15.8  70.7  2,18… 48.5  28.6  75.6  &lt;NA&gt;  &lt;NA&gt; 
6 Colorado ..… Colo… 65,4… 65,4… 15.8  73.1  2,35… 49.2  28.6  79.8  &lt;NA&gt;  &lt;NA&gt; 
# … with 2 more variables: col_10 &lt;chr&gt;, year_of_data &lt;dbl&gt;
# ℹ Use `colnames()` to see all variable names</code></pre>
</div>
</div>
<p>We can now grab the correct column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>tfr_data <span class="ot">&lt;-</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  raw_dhs_data <span class="sc">|&gt;</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TFR =</span> <span class="fu">if_else</span>(year_of_data <span class="sc">&lt;</span> <span class="dv">2008</span>, col_4, col_3)) <span class="sc">|&gt;</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, year_of_data, TFR) <span class="sc">|&gt;</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">year =</span> year_of_data)</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tfr_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  state       year TFR    
  &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;  
1 Alabama     2000 2,021.0
2 Alaska      2000 2,437.0
3 Arizona     2000 2,652.5
4 Arkansas    2000 2,140.0
5 California  2000 2,186.0
6 Colorado    2000 2,356.5</code></pre>
</div>
</div>
<p>Finally, we need to convert the case.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tfr_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  state       year TFR    
  &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;  
1 Alabama     2000 2,021.0
2 Alaska      2000 2,437.0
3 Arizona     2000 2,652.5
4 Arkansas    2000 2,140.0
5 California  2000 2,186.0
6 Colorado    2000 2,356.5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>tfr_data <span class="ot">&lt;-</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  tfr_data <span class="sc">|&gt;</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">TFR =</span> <span class="fu">str_remove_all</span>(TFR, <span class="st">","</span>),</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">TFR =</span> <span class="fu">as.numeric</span>(TFR)</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tfr_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  state       year   TFR
  &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;
1 Alabama     2000 2021 
2 Alaska      2000 2437 
3 Arizona     2000 2652.
4 Arkansas    2000 2140 
5 California  2000 2186 
6 Colorado    2000 2356.</code></pre>
</div>
</div>
<p>And run some checks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>tfr_data<span class="sc">$</span>state <span class="sc">|&gt;</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">|&gt;</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">length</span>() <span class="sc">==</span> <span class="dv">51</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>tfr_data<span class="sc">$</span>year <span class="sc">|&gt;</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">|&gt;</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">length</span>() <span class="sc">==</span> <span class="dv">19</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>In particular we want for there to be 51 states and for there to be 19 years.</p>
<p>And we are done (<a href="#tbl-tfrforthewin">Table&nbsp;<span>9.4</span></a>)!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>tfr_data <span class="sc">|&gt;</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(TFR, <span class="sc">~</span> <span class="fu">format</span>(.x, <span class="at">big.mark =</span> <span class="st">","</span>))) <span class="sc">|&gt;</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"State"</span>, <span class="st">"Year"</span>, <span class="st">"TFR"</span>),</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">digits =</span> <span class="dv">0</span>,</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">booktabs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">linesep =</span> <span class="st">""</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="tbl-tfrforthewin" class="anchored">
<table class="table table-sm table-striped">
<caption>Table 9.4: First ten rows of a dataset of TFR by US state, 2000-2019</caption>
<thead>
<tr class="header">
<th style="text-align: left;">State</th>
<th style="text-align: right;">Year</th>
<th style="text-align: left;">TFR</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Alabama</td>
<td style="text-align: right;">2000</td>
<td style="text-align: left;">2,021.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Alaska</td>
<td style="text-align: right;">2000</td>
<td style="text-align: left;">2,437.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Arizona</td>
<td style="text-align: right;">2000</td>
<td style="text-align: left;">2,652.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Arkansas</td>
<td style="text-align: right;">2000</td>
<td style="text-align: left;">2,140.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">California</td>
<td style="text-align: right;">2000</td>
<td style="text-align: left;">2,186.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">Colorado</td>
<td style="text-align: right;">2000</td>
<td style="text-align: left;">2,356.5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Connecticut</td>
<td style="text-align: right;">2000</td>
<td style="text-align: left;">1,931.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Delaware</td>
<td style="text-align: right;">2000</td>
<td style="text-align: left;">2,014.0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">District of Columbia</td>
<td style="text-align: right;">2000</td>
<td style="text-align: left;">1,975.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">Florida</td>
<td style="text-align: right;">2000</td>
<td style="text-align: left;">2,157.5</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><span class="citation" data-cites="kieransparsing">Healy (<a href="99-references.html#ref-kieransparsing" role="doc-biblioref">2022</a>)</span> provides another example of using this same approach in a slightly different context.</p>
</section>
<section id="optical-character-recognition" class="level3" data-number="9.4.3">
<h3 data-number="9.4.3" class="anchored" data-anchor-id="optical-character-recognition"><span class="header-section-number">9.4.3</span> Optical Character Recognition</h3>
<p>All of the above is predicated on having a PDF that is already “digitized”. But what if it is images, such as the result of a scan. Such PDFs often contain unstructured data, meaning that the data are not tagged nor organised in a regular way. Optical character recognition (OCR) is a process that transforms an image of text into actual text. Although there may not be much difference to a human reading a PDF before and after OCR, the PDF is now machine-readable <span class="citation" data-cites="Cheriet2007">(<a href="99-references.html#ref-Cheriet2007" role="doc-biblioref">Cheriet et al. 2007</a>)</span>. OCR has been used to parse images of characters since the 1950s, initially using manual approaches. While manual approaches remain the gold standard, for reasons of cost effectiveness, this has been largely replaced by the use of statistical models.</p>
<p>In this example we use <code>tesseract</code> <span class="citation" data-cites="citetesseract">(<a href="99-references.html#ref-citetesseract" role="doc-biblioref">Ooms 2019b</a>)</span> to OCR a document. This is a R wrapper around the Tesseract open-source OCR engine. Tesseract was initially developed at HP in the 1980s, and is now mostly developed by Google.</p>
<p>Let us see an example with a scan from the first page of Jane Eyre (<a href="#fig-janescan">Figure&nbsp;<span>9.15</span></a>).</p>
<div id="fig-janescan" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/jane_scan.png" class="img-fluid figure-img" style="width:90.0%"></p>
<p></p><figcaption class="figure-caption">Figure 9.15: Scan of first page of Jane Eyre</figcaption><p></p>
</figure>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tesseract)</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>text <span class="ot">&lt;-</span> tesseract<span class="sc">::</span><span class="fu">ocr</span>(</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"jane_scan.png"</span>),</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">engine =</span> <span class="fu">tesseract</span>(<span class="st">"eng"</span>)</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>1 THERE was no possibility of taking a walk that day. We had
been wandering, indeed, in the leafless shrubbery an hour in
the morning; but since dinner (Mrs Reed, when there was no com-
pany, dined early) the cold winter wind had brought with it clouds
so sombre, and a rain so penetrating, that further out-door exercise

was now out of the question.

I was glad of it: I never liked long walks, especially on chilly
afternoons: dreadful to me was the coming home in the raw twi-
light, with nipped fingers and toes, and a heart saddened by the
chidings of Bessie, the nurse, and humbled by the consciousness of
my physical inferiority to Eliza, John, and Georgiana Reed.

The said Eliza, John, and Georgiana were now clustered round
their mama in the drawing-room: she lay reclined on a sofa by the
fireside, and with her darlings about her (for the time neither quar-
relling nor crying) looked perfectly happy. Me, she had dispensed
from joining the group; saying, ‘She regretted to be under the
necessity of keeping me at a distance; but that until she heard from
Bessie, and could discover by her own observation that I was
endeavouring in good earnest to acquire a more sociable and
child-like disposition, a more attractive and sprightly manner—
something lighter, franker, more natural as it were—she really
must exclude me from privileges intended only for contented,
happy, littie children.’

‘What does Bessie say I have done?’ I asked.

‘Jane, I don’t like cavillers or questioners: besides, there is
something truly forbidding in a child taking up her elders in that
manner. Be seated somewhere; and until you can speak pleasantly,
remain silent.’

. a TV

i; STA AEE LT JEUNE TIS Sis
a) | | | a) ee
i Ni 4 | | | ae ST | | a eg

ce A FEM yi | eS ee
Pe TT (SB ag ie pe
is \ ie mu) i i es SS
veal | Dy eT |
pa || i er itl |

aes : Oty ZR UIE OR HMR Sa ote ariel
SEEN ed — =
15</code></pre>
</div>
</div>
<p>In general the result is not too bad. OCR is a useful tool but is not perfect and the resulting data may require extra attention in terms of cleaning. For instance, in the OCR results of <a href="#fig-janescan">Figure&nbsp;<span>9.15</span></a> we see irregularities that would need to be fixed. Various options, such as focusing on the particular data of interest and increase the contrast can help. Other popular OCR engines include Amazon Textract, Google Vision API, and ABBYY.</p>
</section>
</section>
<section id="exercises-and-tutorial" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="exercises-and-tutorial"><span class="header-section-number">9.5</span> Exercises and tutorial</h2>
<section id="exercises" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="exercises">Exercises</h3>
<ol type="1">
<li><em>(Plan)</em> Consider the following scenario: <em>A group of five undergraduates each read some number of pages from a book each day for 100 days. Two of the undergraduates are a couple and so their number of pages is positively correlated, however all the others are independent.</em> Please sketch what that dataset could look like and then sketch a graph that you could build to show all observations.</li>
<li><em>(Simulate)</em> Please further consider the scenario described and simulate the situation with every variable independent of each other.</li>
<li><em>(Acquire)</em> Please describe a possible source of such a dataset.</li>
<li><em>(Explore)</em> Please use <code>ggplot2</code> to build the graph that you sketched using the data that you simulated.</li>
<li><em>(Communicate)</em> Please write two paragraphs about what you did. 6 In your own words, what is an API (write a paragraph or two)?</li>
<li>Find two APIs and discuss how you could use them to tell interesting stories (write a paragraph or two for each)?</li>
<li>Find two APIs that have an R packages written around them. How could you use these to tell interesting stories (write a paragraph or two)?</li>
<li>Please consider the following code, which uses <code>gh</code> <span class="citation" data-cites="gh">(<a href="99-references.html#ref-gh" role="doc-biblioref">Bryan and Wickham 2021</a>)</span> to access the GitHub API (you will need to have set-up GitHub on your computer, as covered in <a href="04-workflow.html"><span>Chapter&nbsp;4</span></a>). When was the repo for <code>heapsofpapers</code> created?
<ol type="a">
<li>2021-02-23</li>
<li>2021-03-06</li>
<li>2021-05-25</li>
<li>2021-04-27</li>
</ol></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Based on Tyler Bradley and Monica Alexander</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gh)</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>repos <span class="ot">&lt;-</span> <span class="fu">gh</span>(<span class="st">"/users/RohanAlexander/repos"</span>, <span class="at">per_page =</span> <span class="dv">100</span>)</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>repo_info <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">map_chr</span>(repos, <span class="st">"name"</span>),</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">created =</span> <span class="fu">map_chr</span>(repos, <span class="st">"created_at"</span>),</span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">full_name =</span> <span class="fu">map_chr</span>(repos, <span class="st">"full_name"</span>),</span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="10" type="1">
<li>Please consider the UN’s <a href="https://population.un.org/dataportal/about/dataapi">Data API</a> and the introductory note on how to use it by <span class="citation" data-cites="schmertmannunapi">Schmertmann (<a href="99-references.html#ref-schmertmannunapi" role="doc-biblioref">2022</a>)</span>. Modify the following code to determine what Argentina’s single-year fertility rate was for 20-year-olds in 1995? (Hint: Argentina’s location code is 32.)
<ol type="a">
<li>147.679</li>
<li>172.988</li>
<li>204.124</li>
<li>128.665</li>
</ol></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Based on Carl Schmertmann</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>my_indicator <span class="ot">&lt;-</span> <span class="dv">68</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>my_location <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>my_startyr <span class="ot">&lt;-</span> <span class="dv">1996</span></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>my_endyr <span class="ot">&lt;-</span> <span class="dv">1999</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"https://population.un.org/dataportalapi/api/v1"</span>,</span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"/data/indicators/"</span>,</span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>  my_indicator,</span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"/locations/"</span>,</span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>  my_location,</span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"/start/"</span>,</span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>  my_startyr,</span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"/end/"</span>,</span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>  my_endyr,</span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"/?format=csv"</span></span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a>un_data <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(<span class="at">file =</span> url, <span class="at">delim =</span> <span class="st">"|"</span>, <span class="at">skip =</span> <span class="dv">1</span>)</span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a>un_data <span class="sc">|&gt;</span></span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(AgeLabel <span class="sc">==</span> <span class="dv">25</span> <span class="sc">&amp;</span> TimeLabel <span class="sc">==</span> <span class="dv">1996</span>) <span class="sc">|&gt;</span></span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="11" type="1">
<li>Please submit the code that you wrote to answer the above question.</li>
<li>What is the main argument to <code>httr::GET()</code> (pick one)?
<ol type="a">
<li>“url”</li>
<li>“website”</li>
<li>“domain”</li>
<li>“location”</li>
</ol></li>
<li>What are three reasons why we should be respectful when getting scraping data from websites (write a paragraph or two)?</li>
<li>What features of a website do we typically take advantage of when we parse the code (pick on)?
<ol type="a">
<li>HTML/CSS mark-up.</li>
<li>Cookies.</li>
<li>Facebook beacons.</li>
<li>Code comments.</li>
</ol></li>
<li>What are three advantages and three disadvantages of scraping compared with using an API (write a paragraph or two)?</li>
<li>What are three delimiters that could be useful when trying to bring order to the PDF that you read in as a character vector (write a paragraph or two)?</li>
<li>Which of the following, used as part of a regular expression, would match a full stop (hint: see the “strings” cheat sheet) (pick one)?
<ol type="a">
<li>“.”</li>
<li>“.”</li>
<li>“\.”</li>
<li>“\.”</li>
</ol></li>
<li>Name three reasons for sketching out what you want before starting to try to extract data from a PDF (write a paragraph or two for each)?</li>
<li>What are three checks that we might like to use for demographic data, such as the number of births in a country in a particular year (write a paragraph or two for check)?</li>
<li>What are three checks that we might like to use for economic data, such as GDP for a particular country in a particular year (write a paragraph or two for check)?</li>
<li>What does the <code>purrr</code> package do (select all that apply)?
<ol type="a">
<li>Enhances R’s functional programming toolkit.</li>
<li>Makes loops easier to code and read.</li>
<li>Checks the consistency of datasets.</li>
<li>Identifies issues in data structures and proposes replacements.</li>
</ol></li>
<li>Which of these are functions from the <code>purrr</code> package (select all that apply)?
<ol type="a">
<li><code>map()</code></li>
<li><code>walk()</code></li>
<li><code>run()</code></li>
<li><code>safely()</code></li>
</ol></li>
<li>What are some principles to follow when scraping (select all that apply)?
<ol type="a">
<li>Avoid it if possible</li>
<li>Follow the site’s guidance</li>
<li>Slow down</li>
<li>Use a scalpel not an axe.<br>
</li>
</ol></li>
<li>What is a robots.txt file (pick one)?
<ol type="a">
<li>The instructions that Frankenstein followed.</li>
<li>Notes that web scrapers should follow when scraping.</li>
</ol></li>
<li>What is the HTML tag for an item in list (pick one)?
<ol type="a">
<li><code>li</code></li>
<li><code>body</code></li>
<li><code>b</code></li>
<li><code>em</code></li>
</ol></li>
<li>Which function should we use if we have the following text data: “rohan_alexander” in a column called “names” and want to split it into first name and surname based on the underscore (pick one)?
<ol type="a">
<li><code>separate()</code></li>
<li><code>slice()</code></li>
<li><code>spacing()</code></li>
<li><code>text_to_columns()</code></li>
</ol></li>
</ol>
</section>
<section id="tutorial" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="tutorial">Tutorial</h3>
<p>Please redo the web scraping example, but for one of: <a href="https://en.wikipedia.org/wiki/List_of_prime_ministers_of_Australia">Australia</a>, <a href="https://en.wikipedia.org/wiki/List_of_prime_ministers_of_Canada">Canada</a>, <a href="https://en.wikipedia.org/wiki/List_of_prime_ministers_of_India">India</a>, or <a href="https://en.wikipedia.org/wiki/List_of_prime_ministers_of_New_Zealand">New Zealand</a>.</p>
<p>Plan, gather, and clean the data, and then use it to create a similar table to the one created above. Write a few paragraphs about your findings. Then write a few paragraphs about the data source, what you gathered, and how you went about it. What took longer than you expected? When did it become fun? What would you do differently next time you do this? Your submission should be at least two pages and likely more.</p>
<p>Please submit a link to a PDF produced using R Markdown that includes a link to the GitHub repo.</p>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-Alexander2020" class="csl-entry" role="doc-biblioentry">
Alexander, Rohan, and Monica Alexander. 2021. <span>“The Increased Effect of Elections and Changing Prime Ministers on Topics Discussed in the Australian Federal Parliament Between 1901 and 2018.”</span> <a href="https://doi.org/10.48550/arXiv.2111.09299">https://doi.org/10.48550/arXiv.2111.09299</a>.
</div>
<div id="ref-heapsofpapers" class="csl-entry" role="doc-biblioentry">
Alexander, Rohan, and A Mahfouz. 2021. <em><span class="nocase">heapsofpapers: Easily Download Heaps of PDF and CSV Files</span></em>. <a href="https://CRAN.R-project.org/package=heapsofpapers">https://CRAN.R-project.org/package=heapsofpapers</a>.
</div>
<div id="ref-bailey2008design" class="csl-entry" role="doc-biblioentry">
Bailey, Rosemary. 2008. <em>Design of Comparative Experiments</em>. Cambridge: Cambridge University Press. <a href="https://doi.org/10.1017/CBO9780511611483">https://doi.org/10.1017/CBO9780511611483</a>.
</div>
<div id="ref-janeeyre" class="csl-entry" role="doc-biblioentry">
Brontë, Charlotte. 1847. <em>Jane Eyre</em>. <a href="https://www.gutenberg.org/files/1260/1260-h/1260-h.htm">https://www.gutenberg.org/files/1260/1260-h/1260-h.htm</a>.
</div>
<div id="ref-gh" class="csl-entry" role="doc-biblioentry">
Bryan, Jenny, and Hadley Wickham. 2021. <em><span class="nocase">gh: GitHub API</span></em>. <a href="https://CRAN.R-project.org/package=gh">https://CRAN.R-project.org/package=gh</a>.
</div>
<div id="ref-Cheriet2007" class="csl-entry" role="doc-biblioentry">
Cheriet, Mohamed, Nawwaf Kharma, Cheng-Lin Liu, and Ching Suen. 2007. <em>Character Recognition Systems: A Guide for Students and Practitioner</em>. Wiley.
</div>
<div id="ref-cirone" class="csl-entry" role="doc-biblioentry">
Cirone, Alexandra, and Arthur Spirling. 2021. <span>“Turning History into Data: Data Collection, Measurement, and Inference in HPE.”</span> <em>Journal of Historical Political Economy</em> 1 (1): 127–54. <a href="https://doi.org/10.1561/115.00000005">https://doi.org/10.1561/115.00000005</a>.
</div>
<div id="ref-collinsalexander" class="csl-entry" role="doc-biblioentry">
Collins, Annie, and Rohan Alexander. 2022. <span>“Reproducibility of COVID-19 Pre-Prints.”</span> <em>Scientometrics</em>. <a href="https://doi.org/10.1007/s11192-022-04418-2">https://doi.org/10.1007/s11192-022-04418-2</a>.
</div>
<div id="ref-crawford" class="csl-entry" role="doc-biblioentry">
Crawford, Kate. 2021. <em><span class="nocase">Atlas of AI</span></em>. New Haven: Yale University Press.
</div>
<div id="ref-Cummins2022" class="csl-entry" role="doc-biblioentry">
Cummins, Neil. 2022. <span>“The Hidden Wealth of English Dynasties, 1892–2016.”</span> <em>The Economic History Review</em> 75 (3): 667–702. <a href="https://doi.org/10.1111/ehr.13120">https://doi.org/10.1111/ehr.13120</a>.
</div>
<div id="ref-scrapecoviddata" class="csl-entry" role="doc-biblioentry">
Eisenstein, Michael. 2022. <span>“Need Web Data? Here’s How to Harvest Them.”</span> <em>Nature</em> 607: 200–201. <a href="https://doi.org/10.1038/d41586-022-01830-9">https://doi.org/10.1038/d41586-022-01830-9</a>.
</div>
<div id="ref-GrolemundWickham2011" class="csl-entry" role="doc-biblioentry">
Grolemund, Garrett, and Hadley Wickham. 2011. <span>“Dates and Times Made Easy with <span class="nocase">lubridate</span>.”</span> <em>Journal of Statistical Software</em> 40 (3): 1–25. <a href="http://www.jstatsoft.org/v40/i03/">http://www.jstatsoft.org/v40/i03/</a>.
</div>
<div id="ref-hackett2016researchers" class="csl-entry" role="doc-biblioentry">
Hackett, Robert. 2016. <span>“<span class="nocase">Researchers Caused an Uproar By Publishing Data From 70,000 OkCupid Users</span>.”</span> <em>Fortune</em>, May. <a href="https://fortune.com/2016/05/18/okcupid-data-research/">https://fortune.com/2016/05/18/okcupid-data-research/</a>.
</div>
<div id="ref-kieransparsing" class="csl-entry" role="doc-biblioentry">
Healy, Kieran. 2022. <span>“Unhappy in Its Own Way,”</span> July. <a href="https://kieranhealy.org/blog/archives/2022/07/22/unhappy-in-its-own-way/">https://kieranhealy.org/blog/archives/2022/07/22/unhappy-in-its-own-way/</a>.
</div>
<div id="ref-citepurrr" class="csl-entry" role="doc-biblioentry">
Henry, Lionel, and Hadley Wickham. 2020. <em><span class="nocase">purrr: Functional Programming Tools</span></em>. <a href="https://CRAN.R-project.org/package=purrr">https://CRAN.R-project.org/package=purrr</a>.
</div>
<div id="ref-Johnson2021Two" class="csl-entry" role="doc-biblioentry">
Johnson, Kaneesha. 2021. <span>“Two Regimes of Prison Data Collection.”</span> <em>Harvard Data Science Review</em> 3 (3). <a href="https://doi.org/10.1162/99608f92.72825001">https://doi.org/10.1162/99608f92.72825001</a>.
</div>
<div id="ref-rtweet" class="csl-entry" role="doc-biblioentry">
Kearney, Michael. 2019. <span>“<span class="nocase">rtweet: Collecting and analyzing Twitter data</span>.”</span> <em>Journal of Open Source Software</em> 4 (42): 1829. <a href="https://doi.org/10.21105/joss.01829">https://doi.org/10.21105/joss.01829</a>.
</div>
<div id="ref-kirkegaard2016okcupid" class="csl-entry" role="doc-biblioentry">
Kirkegaard, Emil, and Julius Bjerrekær. 2016. <span>“The OKCupid Dataset: A Very Large Public Dataset of Dating Site Users.”</span> <em>Open Differential Psychology</em>, 1–10. <a href="https://doi.org/10.26775/ODP.2016.11.03">https://doi.org/10.26775/ODP.2016.11.03</a>.
</div>
<div id="ref-luscombe2021algorithmic" class="csl-entry" role="doc-biblioentry">
Luscombe, Alex, Kevin Dick, and Kevin Walby. 2021. <span>“Algorithmic Thinking in the Public Interest: Navigating Technical, Legal, and Ethical Hurdles to Web Scraping in the Social Sciences.”</span> <em>Quality &amp; Quantity</em>, 1–22. <a href="https://doi.org/10.1007/s11135-021-01164-0">https://doi.org/10.1007/s11135-021-01164-0</a>.
</div>
<div id="ref-jsonlite" class="csl-entry" role="doc-biblioentry">
Ooms, Jeroen. 2014. <span>“<span class="nocase">The jsonlite Package: A Practical and Consistent Mapping Between JSON Data and R Objects</span>.”</span> <em>arXiv:1403.2805 [Stat.CO]</em>. <a href="https://arxiv.org/abs/1403.2805">https://arxiv.org/abs/1403.2805</a>.
</div>
<div id="ref-pdftools" class="csl-entry" role="doc-biblioentry">
———. 2019a. <em><span class="nocase">pdftools: Text Extraction, Rendering and Converting of PDF Documents</span></em>. <a href="https://CRAN.R-project.org/package=pdftools">https://CRAN.R-project.org/package=pdftools</a>.
</div>
<div id="ref-citetesseract" class="csl-entry" role="doc-biblioentry">
———. 2019b. <em><span class="nocase">tesseract: Open Source OCR Engine</span></em>. <a href="https://CRAN.R-project.org/package=tesseract">https://CRAN.R-project.org/package=tesseract</a>.
</div>
<div id="ref-kaylinpavlik" class="csl-entry" role="doc-biblioentry">
Pavlik, Kaylin. 2019. <span>“Understanding + Classifying Genres Using Spotify Audio Features.”</span> <a href="https://www.kaylinpavlik.com/classifying-songs-genres/">https://www.kaylinpavlik.com/classifying-songs-genres/</a>.
</div>
<div id="ref-polite" class="csl-entry" role="doc-biblioentry">
Perepolkin, Dmytro. 2019. <em>Polite: Be Nice on the Web</em>. <a href="https://CRAN.R-project.org/package=polite">https://CRAN.R-project.org/package=polite</a>.
</div>
<div id="ref-twitterseemsokay" class="csl-entry" role="doc-biblioentry">
Pfeffer, Juergen, Angelina Mooseder, Luca Hammer, Oliver Stritzel, and David Garcia. 2022. <span>“This Sample Seems to Be Good Enough! Assessing Coverage and Temporal Reliability of Twitter’s Academic API.”</span> arXiv. <a href="https://doi.org/10.48550/arXiv.2204.02290">https://doi.org/10.48550/arXiv.2204.02290</a>.
</div>
<div id="ref-salganik2006experimental" class="csl-entry" role="doc-biblioentry">
Salganik, Matthew, Peter Sheridan Dodds, and Duncan Watts. 2006. <span>“Experimental Study of Inequality and Unpredictability in an Artificial Cultural Market.”</span> <em>Science</em> 311 (5762): 854–56. <a href="https://doi.org/10.1126/science.1121066">https://doi.org/10.1126/science.1121066</a>.
</div>
<div id="ref-huggingfaceethics" class="csl-entry" role="doc-biblioentry">
Saulnier, Lucile, Siddharth Karamcheti, Hugo Laurençon, Léo Tronchon, Thomas Wang, Victor Sanh, Amanpreet Singh, et al. 2022. <span>“Putting Ethical Principles at the Core of the Research Lifecycle.”</span> <a href="https://huggingface.co/blog/ethical-charter-multimodal">https://huggingface.co/blog/ethical-charter-multimodal</a>.
</div>
<div id="ref-schmertmannunapi" class="csl-entry" role="doc-biblioentry">
Schmertmann, Carl. 2022. <span>“UN API Test,”</span> July. <a href="https://bonecave.schmert.net/un-api-example.html">https://bonecave.schmert.net/un-api-example.html</a>.
</div>
<div id="ref-theeconomistonspotify" class="csl-entry" role="doc-biblioentry">
The Economist. 2022. <span>“What Spotify Data Show about the Decline of English,”</span> January. <a href="https://www.economist.com/interactives/graphic-detail/2022/01/29/what-spotify-data-show-about-the-decline-of-english">https://www.economist.com/interactives/graphic-detail/2022/01/29/what-spotify-data-show-about-the-decline-of-english</a>.
</div>
<div id="ref-spotifyr" class="csl-entry" role="doc-biblioentry">
Thompson, Charlie, Josiah Parry, Donal Phipps, and Tom Wolff. 2020. <em><span class="nocase">spotifyr: R Wrapper for the <span>“Spotify”</span> Web API</span></em>. <a href="http://github.com/charlie86/spotifyr">http://github.com/charlie86/spotifyr</a>.
</div>
<div id="ref-citehttr" class="csl-entry" role="doc-biblioentry">
Wickham, Hadley. 2019a. <em><span class="nocase">httr: Tools for Working with URLs and HTTP</span></em>. <a href="https://CRAN.R-project.org/package=httr">https://CRAN.R-project.org/package=httr</a>.
</div>
<div id="ref-citervest" class="csl-entry" role="doc-biblioentry">
———. 2019b. <em><span class="nocase">rvest: Easily Harvest (Scrape) Web Pages</span></em>. <a href="https://CRAN.R-project.org/package=rvest">https://CRAN.R-project.org/package=rvest</a>.
</div>
<div id="ref-tidyverse" class="csl-entry" role="doc-biblioentry">
Wickham, Hadley, Mara Averick, Jenny Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain François, Garrett Grolemund, et al. 2019. <span>“Welcome to the <span class="nocase">tidyverse</span>.”</span> <em>Journal of Open Source Software</em> 4 (43): 1686. <a href="https://doi.org/10.21105/joss.01686">https://doi.org/10.21105/joss.01686</a>.
</div>
<div id="ref-citeusethis" class="csl-entry" role="doc-biblioentry">
Wickham, Hadley, and Jenny Bryan. 2020. <em><span class="nocase">usethis: Automate Package and Project Setup</span></em>. <a href="https://CRAN.R-project.org/package=usethis">https://CRAN.R-project.org/package=usethis</a>.
</div>
<div id="ref-xml2" class="csl-entry" role="doc-biblioentry">
Wickham, Hadley, Jim Hester, and Jeroen Ooms. 2021. <em><span class="nocase">xml2: Parse XML</span></em>. <a href="https://CRAN.R-project.org/package=xml2">https://CRAN.R-project.org/package=xml2</a>.
</div>
<div id="ref-facebookapitrump" class="csl-entry" role="doc-biblioentry">
Wong, Julia Carrie. 2020. <span>“One Year Inside Trump’s Monumental Facebook Campaign.”</span> <em>The Guardian</em>, January. <a href="https://www.theguardian.com/us-news/2020/jan/28/donald-trump-facebook-ad-campaign-2020-election">https://www.theguardian.com/us-news/2020/jan/28/donald-trump-facebook-ad-campaign-2020-election</a>.
</div>
<div id="ref-zimmer2018addressing" class="csl-entry" role="doc-biblioentry">
Zimmer, Michael. 2018. <span>“Addressing Conceptual Gaps in Big Data Research Ethics: An Application of Contextual Integrity.”</span> <em>Social Media + Society</em> 4 (2): 1–11. <a href="https://doi.org/10.1177/2056305118768300">https://doi.org/10.1177/2056305118768300</a>.
</div>
</div>
</section>
</section>
<section class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1" role="doc-endnote"><p>If this link does not work then the PDF can be viewed <a href="https://github.com/RohanAlexander/telling_stories/blob/main/inputs/pdfs/dhs/year_2000.pdf">here</a>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>If you want the data to run this code yourself then use: <code>summary_tfr_dataset &lt;- read_csv("https://raw.githubusercontent.com/RohanAlexander/telling_stories/main/inputs/tfr_tables_info.csv")</code>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./08-farm.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Farm data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./10-hunt.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Hunt data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>